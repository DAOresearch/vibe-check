# Vibe-Check Testing Specification v1.0

**Status**: Draft
**Last Updated**: 2025-10-07
**Related**: technical-specification.md v1.4

---

## Table of Contents
- [1. Introduction & Purpose](#1-introduction--purpose)
- [2. Testing Philosophy & Principles](#2-testing-philosophy--principles)
- [3. Claude Code SDK Mocking Strategy](#3-claude-code-sdk-mocking-strategy)
- [4. Test Inventory](#4-test-inventory)
  - [4.1 Core Test Infrastructure](#41-core-test-infrastructure)
  - [4.2 Agent Runner & Context Manager](#42-agent-runner--context-manager)
  - [4.3 Storage System](#43-storage-system)
  - [4.4 Judge System](#44-judge-system)
  - [4.5 Reporters](#45-reporters)
  - [4.6 Matrix Testing](#46-matrix-testing)
  - [4.7 Configuration](#47-configuration)
  - [4.8 File Change Tracking](#48-file-change-tracking)
  - [4.9 Tool Call Processing](#49-tool-call-processing)
  - [4.10 Workflow System](#410-workflow-system)
  - [4.11 Error Handling](#411-error-handling)
  - [4.12 Performance & Cost Tracking](#412-performance--cost-tracking)
- [5. Architecture Decisions](#5-architecture-decisions)
- [6. Implementation Roadmap](#6-implementation-roadmap)
- [7. Maintenance & Evolution](#7-maintenance--evolution)
- [Appendix A: Fixture Reference](#appendix-a-fixture-reference)
- [Appendix B: Test Naming Conventions](#appendix-b-test-naming-conventions)
- [Appendix C: Coverage Requirements Matrix](#appendix-c-coverage-requirements-matrix)

---

## 1. Introduction & Purpose

This document formalizes the executable definition of correctness for the Vibe-Check project. It is the contract that implementation work must satisfy. Tests specified here are designed to be written before implementation and to guide all subsequent code generation. When every test described in this specification passes, the implementation is considered conformant with the Technical Specification v1.4.

Key objectives:
- Translate the technical specification into actionable, verifiable test scaffolds.
- Ensure deterministic, repeatable validation of behavior across unit, integration, and workflow layers.
- Provide clear guidance for fixture management, SDK mocking, and assertion patterns tailored to LLM-generated code.
- Create a maintainable blueprint for future contributors to extend the test suite with confidence.

---

## 2. Testing Philosophy & Principles

### 2.1 Test-Driven Development for LLM-Generated Code
- All tests are authored prior to implementation. They embody the acceptance criteria derived from the technical specification.
- Implementation code (largely generated by LLMs) must be treated as opaque; reviewers focus on test correctness and coverage breadth.
- Each test explicitly documents the invariants, edge cases, and failure modes it protects. Comments within tests describe intent, not implementation details.
- No production code merges without corresponding tests defined in this document.

### 2.2 Fixture Architecture & Dependency Injection
- All fixtures are provided via constructor-based helpers (e.g., `createContextManagerFixture(opts)`) to enforce explicit dependency declaration and avoid implicit globals.
- Fixtures are composed using dependency injection. Every module under test receives its dependencies as parameters, allowing fine-grained substitution with mocks or recorder-based replays.
- Shared fixture factories live in `tests/fixtures/` with subdirectories per subsystem (e.g., `tests/fixtures/storage/createRunBundleFixture.ts`). Inline fixtures within test files are prohibited.
- Fixtures return fully-initialized instances ready for use, but expose hooks for customization (e.g., override storage path, inject fake timers).

### 2.3 Test Organization Principles
- Tests mirror the source directory: `tests/unit/<module>/`, `tests/integration/<feature>/`, `tests/e2e/<workflow>/`.
- Each test file follows the pattern `<module>.<scope>.test.ts` (e.g., `agent-runner.execution.unit.test.ts`). Suites use `describe` blocks that map to specification subsections.
- Tests are isolated: no shared mutable state across test cases. Use `beforeEach` to reset fixtures. Avoid reliance on execution order.
- Shared utilities (e.g., matcher extensions, fixture builders) live under `tests/utils/` and are imported explicitly.

### 2.4 What to Test vs. What Not to Test
- Focus on public interfaces, exported functions, and observable behavior. Private helpers are tested indirectly via public APIs.
- Unit tests mock external systems (Claude Code SDK, file system) unless explicitly designated as integration tests.
- Integration tests validate collaboration between two or more modules within the same subsystem while still mocking external dependencies.
- End-to-end (E2E) tests are reserved for user-facing workflows that span multiple subsystems and require realistic data playback.
- Avoid redundant assertions that mirror implementation details. Each assertion must provide unique signal about behavior or contract compliance.

### 2.5 Data Management Strategy
- Test data resides under `tests/__fixtures__/`. Each subsystem has its own directory with README documenting fixture purposes.
- Recorder-based fixtures for the Claude Code SDK are versioned by scenario and SDK semantic version. Old fixtures remain for reproducibility until superseded.
- Snapshot testing is limited to serialized run bundles and reporter outputs. Snapshots live in `tests/__snapshots__/` with descriptive names; they must be human-reviewable.
- Demo repositories for recorder sessions are stored under `tests/demo-workspaces/` and kept minimal to shorten playback time.

### 2.6 Quality Gates
- Coverage thresholds: **Core modules ≥ 95%**, supporting modules ≥ 90%, utility modules ≥ 85%. Coverage enforced via `vitetest --coverage` in CI.
- Performance guardrails: Full unit test suite ≤ 45s, integration suite ≤ 90s, recorder-backed E2E suite ≤ 5 minutes.
- CI requires passing lint, type-check (`tsc --noEmit`), and all test suites. Failing tests block merges.
- Flaky tests are treated as failures; reruns are not allowed without root cause fixes.

---

## 3. Claude Code SDK Mocking Strategy

### 3.1 Chosen Approach
We adopt a **hybrid mocking strategy** combining a recorder/replay system for complex agent interactions and lightweight deterministic mocks for simple scenarios.

**Justification**:
- Recorder fixtures capture real SDK behavior, ensuring fidelity for complex workflows (multi-stage agents, git interactions, tool usage).
- Lightweight mocks speed up simple unit tests where full SDK playback is unnecessary (e.g., verifying argument forwarding, error propagation).
- Hybrid approach balances realism with maintainability and performance.

**Trade-offs Accepted**:
- Maintaining dual systems requires clear guidelines on which to use. Mitigated by documentation and lint rules enforcing fixture selection.
- Recorder fixtures demand periodic refresh when SDK versions change. Addressed via metadata and CI warnings when versions drift.

### 3.2 Recorder Infrastructure
- Recorder lives under `tests/__fixtures__/claude-sdk/recorder/` with two primary components:
  1. `ClaudeSdkRecorder`: Proxy that wraps the real SDK client during recording sessions.
  2. `ClaudeSdkReplay`: Mock implementation used in tests, replaying recorded interactions.
- Recording is triggered via `pnpm test:record-sdk --scenario <name> --workspace <path>`. This script initializes the recorder, executes predefined scenarios, and writes fixtures.
- Each recording is versioned by SDK version and scenario slug: `tests/__fixtures__/claude-sdk/scenarios/<scenario>/<sdkVersion>/`.

### 3.3 Capture Specification
- **Inputs Captured**:
  - Agent configuration (model, temperature, tools, max tokens, stop sequences).
  - Initial prompts and all subsequent user messages.
  - Workspace metadata (root path, git status, environment variables relevant to SDK behavior).
  - Test harness context: scenario name, description, linked technical spec sections.
- **Outputs Captured**:
  - Full hook stream (PreToolUse, PostToolUse, Notification, RunStep, Stop, Error) with timestamps and correlation IDs.
  - File modifications with before/after content, path metadata, and git diffs.
  - Tool invocations including parameters, stdout/stderr, and return values.
  - RunResult summary: status, completion reason, usage metrics, cost breakdown.
  - Errors, warnings, and recovery attempts (e.g., retries, fallback prompts).

### 3.4 Storage Format
```
tests/__fixtures__/claude-sdk/
  scenarios/
    simple-file-edit/
      2025-10-01-sdk1.12.0/
        input.json
        workspace.zip
        hooks/
          001-pre-tool-use.json
          002-post-tool-use.json
          ...
        output.json
        metadata.json
    multi-file-refactor/
      2025-10-01-sdk1.12.0/
        ...
  README.md
```
- `input.json`: Agent configuration, prompt transcripts, environment snapshot.
- `workspace.zip`: Archived workspace before scenario execution.
- `hooks/`: Ordered JSON files storing raw hook payloads.
- `output.json`: Normalized RunResult representation.
- `metadata.json`: Scenario description, SDK version, checksum hashes, recording author.

### 3.5 Replay Mechanism
- `ClaudeSdkReplay` exposes the same API as the real SDK client. On instantiation, tests provide a scenario key and optional overrides.
- Replay matches incoming requests against recorded inputs using deterministic hashing of prompt transcripts + configuration. Mismatches throw descriptive errors guiding fixture updates.
- Hooks, tool outputs, and RunResults are streamed from fixtures in recorded order. Replay enforces timeline determinism by comparing expected vs actual call sequence.
- Missing scenarios trigger explicit failures with actionable messages: "Fixture not found. Run `pnpm test:record-sdk --scenario ...`".

### 3.6 Traditional Mock Usage
- Lightweight mocks live in `tests/__fixtures__/claude-sdk/mocks/` and provide canned responses for unit tests focused on parameter validation or error propagation.
- These mocks expose deterministic behavior (e.g., immediate success/failure) and skip hook streaming. Use them only when the test explicitly states no hooks should be emitted.

### 3.7 Demo Workspace Scenarios
Recordings cover the following baseline scenarios:
1. Simple file edit.
2. Multi-file refactor with staged commits.
3. Git commit workflow (commit + push attempt).
4. Error correction loop after lint failure.
5. Multi-agent collaboration (primary + reviewer).
6. Tool usage: shell command execution with stdout capture.
7. File deletion and restoration.
8. Large change set (100+ files) with performance profiling.
9. Cost budget enforcement scenario.
10. TODO completion workflow referencing tracked tasks.
11. Hook failure recovery (simulated missing hook).
12. Session timeout and retry handling.

Each scenario has acceptance notes referencing relevant technical spec sections to ensure alignment.

### 3.8 Implementation Guidance
- Recorder/Replayer classes provide TypeScript interfaces aligning with `ClaudeCodeClient` from the SDK bridge.
- LLM implementers must respect the recorder contract: deterministic hashing, explicit error messages, and metadata validation.
- Extending scenarios requires updating `tests/__fixtures__/claude-sdk/scenarios/README.md` with context and ensuring `metadata.json` includes `coversSections` array.

---

## 4. Test Inventory

This section enumerates the executable test contract for every module described in the technical specification. Each module entry follows a consistent structure covering strategy, scaffolds, and detailed cases.

### 4.1 Core Test Infrastructure

#### Module: vibeTest
**Location**: `src/testing/vibeTest.ts`\
**Dependencies**: Vitest, VibeTestContext, AgentRunner, Judge system, configuration loader\
**Complexity**: High

### Test Coverage Strategy
- **Unit Tests**: 8
  - Focus on fixture extension, lifecycle management, argument validation, watcher plumbing.
  - Mocking: Vitest APIs, AgentRunner/Judge stubs.
  - Fixtures: `createViteTestContextFixture`, `createAgentRunnerStub`, `createJudgeStub`.
- **Integration Tests**: 3
  - Focus on real interaction with vibeWorkflow and configuration defaults.
  - Real dependencies: Stage manager, vibeWorkflow orchestrator.
  - Fixtures: ClaudeSdkReplay simple-file-edit scenario, in-memory storage.
- **E2E Tests**: Not required (covered by workflow E2E).

### Test Scaffolds

#### Unit Tests

##### describe('vibeTest - context exposure')
- **`it('injects runAgent and judge methods matching spec signatures')`**
  - **Validates**: `vibeTest` extends Vitest context with fully-typed `runAgent`/`judge`.
  - **Fixtures**: Vitest context stub, AgentRunner/Judge spies.
  - **Setup**: Use DI to inject spies via fixture factory.
  - **Edge cases**: Invocation before fixture ready should throw informative error.
  - **Error scenarios**: Missing dependencies produce error referencing setup docs.
  - **Pass criteria**: Methods exist, types align, spies invoked with provided options.

- **`it('resets cumulative state between tests')`**
  - **Validates**: Context isolation per test run.
  - **Fixtures**: Sequential invocation harness.
  - **Setup**: Preload context state then run second test ensuring emptiness.
  - **Edge cases**: Reusing fixture in same test retains state.
  - **Pass criteria**: Second run sees empty arrays/maps.

##### describe('vibeTest - option handling')
- **`it('merges timeout from config and per-test override')`**
  - **Validates**: Timeout resolution logic.
  - **Fixtures**: Config fixture with default; override via test options.
  - **Edge cases**: `undefined` uses default, explicit `null` disables.
  - **Pass criteria**: Effective timeout equals expected value.

- **`it('throws descriptive error when unknown option provided')`**
  - **Validates**: Defensive option validation.
  - **Fixtures**: Provide unsupported option; expect error message referencing config schema.
  - **Pass criteria**: Error thrown and message matches spec-specified format.

##### describe('vibeTest - lifecycle hooks')
- **`it('awaits async beforeEach/afterEach hooks sequentially')`**
  - **Validates**: Hook execution order and awaiting.
  - **Fixtures**: Async spies capturing timestamps.
  - **Edge cases**: Hook rejection bubbles to test failure.
  - **Pass criteria**: Observed order matches spec: beforeEach → test → afterEach.

- **`it('wraps fixture errors with context metadata')`**
  - **Validates**: Error augmentation with fixture name.
  - **Fixtures**: Fixture factory purposely throws sentinel error.
  - **Pass criteria**: Error includes prefix `vibeTest fixture "<name>" failed`.

##### describe('vibeTest - runAgent integration')
- **`it('returns AgentExecution with Promise interface and watch method')`**
  - **Validates**: `runAgent` return type extends Promise + `watch`.
  - **Fixtures**: AgentRunner stub returning custom execution object.
  - **Edge cases**: `await` usage, `then` chaining.
  - **Pass criteria**: Execution resolves underlying RunResult, `watch` invoked sequentially.

- **`it('queues watcher callbacks without parallel execution')`**
  - **Validates**: Sequential guarantee documented in spec.
  - **Fixtures**: Fake timers to simulate asynchronous hook stream.
  - **Edge cases**: Long-running watcher must block subsequent watchers.
  - **Pass criteria**: Observed invocation order strictly serial.

#### Integration Tests

##### describe('vibeTest - configuration wiring')
- **`it('exposes config defaults from defineVibeConfig inside context')`**
  - **Validates**: Config values accessible via context.
  - **Components**: defineVibeConfig → vibeTest → context.
  - **Real vs Mock**: Real config loader, mocked AgentRunner.
  - **Data flow**: Config default model/budget flows to context properties.
  - **Pass criteria**: Context fields equal config defaults.

##### describe('vibeTest - recorder-backed run')
- **`it('executes simple-file-edit scenario using ClaudeSdkReplay')`**
  - **Validates**: Integration with recorder infrastructure.
  - **Components**: vibeTest, AgentRunner, ContextManager, ClaudeSdkReplay.
  - **Real vs Mock**: Replay client real, storage mocked in-memory.
  - **Pass criteria**: RunResult matches fixture metadata; hooks captured.

##### describe('vibeTest - workflow interoperability')
- **`it('allows vibeWorkflow stages within test body and preserves context')`**
  - **Validates**: Combined use of vibeTest + vibeWorkflow.
  - **Components**: Stage manager, watchers.
  - **Pass criteria**: Stage context inherits run history, watchers triggered once.

---

#### Module: vibeWorkflow
**Location**: `src/testing/vibeWorkflow.ts`\
**Dependencies**: StageManager, WorkflowContext, AgentRunner, hooks.\
**Complexity**: High

### Test Coverage Strategy
- **Unit Tests**: 6
  - Focus on stage registration, lifecycle, nested workflows, context propagation.
  - Mocking: StageManager stub, WorkflowContext fixture.
- **Integration Tests**: 4
  - Focus on cooperation with AgentRunner and watchers.
  - Fixtures: Recorder scenarios for stage-level runs.
- **E2E Tests**: 1
  - Scenario: Plan → Execute → Review loop using recorder data.

### Test Scaffolds

#### Unit Tests

##### describe('vibeWorkflow - stage definition')
- **`it('registers stage metadata with unique IDs')`**
  - **Validates**: Stage registration ensures unique identifiers and metadata persisted.
  - **Fixtures**: StageManager mock verifying `registerStage` calls.
  - **Edge cases**: Duplicate names produce descriptive error.
  - **Pass criteria**: Each stage registration returns unique ID.

- **`it('creates stage-scoped context inheriting parent run history')`**
  - **Validates**: Stage context includes parent history but isolates stage state.
  - **Fixtures**: WorkflowContext fixture preloaded with prior runs.
  - **Pass criteria**: Stage context contains parent history arrays but new stage local state empty.

##### describe('vibeWorkflow - lifecycle management')
- **`it('executes cleanup callbacks even when stage throws')`**
  - **Validates**: `try/finally` semantics around stage execution.
  - **Fixtures**: Stage block that throws sentinel error; cleanup spy.
  - **Pass criteria**: Cleanup invoked once despite error.

- **`it('serializes stage execution preventing concurrent runs')`**
  - **Validates**: Stage queue ensures sequential execution.
  - **Fixtures**: Two asynchronous stages, use fake timers.
  - **Pass criteria**: Second stage starts only after first resolves.

##### describe('vibeWorkflow - nested usage safeguards')
- **`it('throws informative error when nested without allowNested flag')`**
  - **Validates**: Guard against unintended nested workflows.
  - **Pass criteria**: Error message references `allowNested`.

- **`it('permits nested workflows when allowNested=true propagating shared context')`**
  - **Validates**: Controlled nesting shares context but isolates stage metadata.
  - **Fixtures**: allowNested flag, StageManager verifying nested registration.
  - **Pass criteria**: Inner workflow runs successfully and context shows nested stage IDs.

#### Integration Tests

##### describe('vibeWorkflow - agent orchestration')
- **`it('runs AgentRunner within stage and records timeline entries')`**
  - **Validates**: Stage execution integrates with AgentRunner run timeline.
  - **Components**: vibeWorkflow, AgentRunner, ContextManager.
  - **Pass criteria**: Stage timeline entries match recorder hooks.

- **`it('propagates stage failure to parent test with annotated error')`**
  - **Validates**: Stage errors bubble up with stage metadata.
  - **Pass criteria**: Error includes stage name and ID.

- **`it('shares cross-stage state via WorkflowContext storage')`**
  - **Validates**: Data stored in workflow context accessible across stages.
  - **Pass criteria**: Stage B reads value Stage A stored.

- **`it('supports until() helper for iterative improvements')`**
  - **Validates**: until loop integration with stage transitions.
  - **Pass criteria**: Loop stops when predicate satisfied; run count recorded.

#### E2E Tests

##### describe('vibeWorkflow - multi-stage refactor workflow')
- **`it('executes plan → implement → review loop using recorded scenario')`**
  - **Validates**: Full workflow with judge gating and iterative reruns.
  - **Journey**: Stage 1 plan, Stage 2 implement, Stage 3 judge + conditional rerun.
  - **Entry point**: vibeTest body.
  - **Exit point**: Verified RunResult stored in bundle.
  - **Success state**: Judge returns pass, workflow terminates without exceeding budget.
  - **Pass criteria**: Final RunResult meets rubric, timeline includes all stages.

---

#### Module: Test Context & Fixtures
**Location**: `src/testing/context/`\
**Dependencies**: ContextManager, AgentRunner, storage, Judge.\
**Complexity**: High

### Test Coverage Strategy
- **Unit Tests**: 10
  - Focus on construction, state accumulation, teardown, error wrapping.
  - Mocking: AgentRunner stub, storage stub, logger spy.
- **Integration Tests**: 3
  - Focus on interaction with real ContextManager and recorder scenarios.
- **E2E Tests**: Not required.

### Test Scaffolds

#### Unit Tests

##### describe('createVibeTestContext - construction')
- **`it('injects AgentRunner and Judge dependencies via DI container')`**
  - **Validates**: Constructor receives dependencies from fixture factory.
  - **Fixtures**: `createContextFixture({ agentRunner, judge })`.
  - **Pass criteria**: Context methods call provided dependencies.

- **`it('initializes cumulative trackers to empty arrays/maps')`**
  - **Validates**: Baseline state.
  - **Pass criteria**: `context.files`, `context.tools`, `context.timeline` start empty.

##### describe('createVibeTestContext - state accumulation')
- **`it('appends file changes after each runAgent invocation')`**
  - **Validates**: File tracking across runs.
  - **Fixtures**: Provide synthetic RunResult with file changes.
  - **Pass criteria**: Files array appended with correct metadata.

- **`it('records tool calls preserving correlation IDs')`**
  - **Validates**: Tool tracking.
  - **Pass criteria**: Tool entries include Pre/Post pair ID.

- **`it('stores RunResult history in execution order')`**
  - **Validates**: Order preservation for sequential runs.
  - **Pass criteria**: History array equals chronological run order.

##### describe('createVibeTestContext - teardown')
- **`it('disposes watchers and clears subscriptions on destroy')`**
  - **Validates**: Resource cleanup.
  - **Pass criteria**: Watcher spies not invoked post-disposal.

- **`it('flushes pending storage writes before returning')`**
  - **Validates**: Storage flush invocation.
  - **Pass criteria**: Storage mock receives `flush` call once.

##### describe('createVibeTestContext - error handling')
- **`it('wraps runAgent errors with context metadata without losing stack')`**
  - **Validates**: Error augmentation.
  - **Pass criteria**: Error message includes run index, retains original stack.

- **`it('retains partial state when runAgent fails mid-execution')`**
  - **Validates**: Partial results accessible.
  - **Pass criteria**: Files/tools arrays include partial data captured before failure.

- **`it('records judge failures and surfaces via attachments')`**
  - **Validates**: Failure path for judge.
  - **Pass criteria**: Judge error appended to context `judgments` collection.

#### Integration Tests

##### describe('VibeTestContext - recorder integration')
- **`it('captures hook data from recorded scenario and updates trackers')`**
  - **Components**: ContextManager, AgentRunner, ClaudeSdkReplay.
  - **Pass criteria**: Trackers match fixture data.

- **`it('persists RunBundle via storage fixture on dispose')`**
  - **Components**: RunBundleStore fixture.
  - **Pass criteria**: Storage contains bundle with expected metadata.

- **`it('invokes judge with RunResult from recorder and stores structured result')`**
  - **Components**: Judge fixture using deterministic response.
  - **Pass criteria**: Judgment stored with rubric metadata.

---

#### Module: Custom Matchers
**Location**: `src/testing/matchers/`\
**Dependencies**: Vitest `expect`, RunResult structures, tool timeline utilities.\
**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 12 (3 per matcher × 4 primary matchers).
  - Focus on success/failure/negation and message clarity.
  - Fixtures: Synthetic RunResult and tool data.
- **Integration Tests**: 2
  - Focus on global registration and use inside vibeTest.
- **E2E Tests**: Not required.

### Test Scaffolds

#### Unit Tests

##### describe('toHaveCompleteHookData')
- **`it('passes when hookCaptureStatus is complete and hooks cover timeline')`**
  - **Validates**: Matcher success path.
  - **Fixtures**: RunResult fixture with `hookCaptureStatus: 'complete'`.
  - **Pass criteria**: Matcher returns pass with empty diff.

- **`it('fails with descriptive diff when hooks missing')`**
  - **Validates**: Failure message includes missing hook IDs.
  - **Pass criteria**: Error message lists absent hooks.

- **`it('supports negation to assert partial capture')`**
  - **Validates**: `.not` path.
  - **Pass criteria**: Negated matcher passes when status != complete.

(Repeat identical structure for `toMatchToolTimeline`, `toRespectCostBudget`, `toHaveGitSnapshot`.)

#### Integration Tests

##### describe('Matchers registration')
- **`it('registers matchers globally via setup file')`**
  - **Validates**: `expect.extend` executed once before tests.
  - **Pass criteria**: `expect().toHaveCompleteHookData` available without import.

- **`it('operates against recorder-produced RunResult in vibeTest flow')`**
  - **Validates**: Matchers handle real data shapes.
  - **Pass criteria**: Assertions succeed on known-good scenario.

---

### 4.2 Agent Runner & Context Manager

#### Module: AgentRunner
**Location**: `src/agent/AgentRunner.ts`\
**Dependencies**: Claude SDK bridge, ContextManager, Hook capture, storage, workflow watchers.\
**Complexity**: High

### Test Coverage Strategy
- **Unit Tests**: 14
  - Validate initialization, execution lifecycle, watchers, error handling, abort.
  - Mocking: ClaudeSdkReplay (for complex), deterministic mocks for validation, fake timers.
- **Integration Tests**: 6
  - Validate recorder scenarios, git capture, budget enforcement, retries.
- **E2E Tests**: 2
  - Validate complex workflows end-to-end.

### Test Scaffolds

#### Unit Tests

##### describe('AgentRunner - initialization')
- **`it('requires agent definition with prompt and tools per spec')`**
  - **Validates**: Input validation.
  - **Fixtures**: Agent definition factory.
  - **Pass criteria**: Missing prompt/tools throws `AgentRunnerConfigurationError`.

- **`it('merges config defaults with per-run overrides')`**
  - **Validates**: Option merge order (run overrides > config > global).
  - **Pass criteria**: Resolved config matches expected object.

##### describe('AgentRunner - execution lifecycle')
- **`it('streams hook events to ContextManager sequentially')`**
  - **Validates**: Hook ordering and dispatch.
  - **Fixtures**: ContextManager spy verifying order.
  - **Pass criteria**: Pre/Post pairs forwarded with matching IDs.

- **`it('supports abort signal cancellation propagating to SDK client')`**
  - **Validates**: Abort integration.
  - **Fixtures**: AbortController, mocked SDK verifying `abort`.
  - **Pass criteria**: Run rejects with `AbortError`, SDK receives cancellation.

- **`it('records token usage and cost from SDK response')`**
  - **Validates**: Usage extraction.
  - **Pass criteria**: RunResult usage matches fixture values.

##### describe('AgentRunner - watchers')
- **`it('invokes registered watchers with partial RunResult updates')`**
  - **Validates**: Watch API semantics.
  - **Pass criteria**: Watcher called with partial context each hook.

- **`it('runs watchers sequentially without overlapping executions')`**
  - **Validates**: Serial guarantee.
  - **Pass criteria**: Next watcher starts after previous resolves.

##### describe('AgentRunner - error handling')
- **`it('wraps SDK errors inside RunResult with status=failed')`**
  - **Validates**: Error wrapping contract.
  - **Pass criteria**: RunResult includes failure metadata and original error message.

- **`it('handles hook capture failure by marking hookCaptureStatus partial')`**
  - **Validates**: Graceful degradation.
  - **Pass criteria**: RunResult includes partial status, warning logged once.

- **`it('retries on transient SDK errors when policy enabled')`**
  - **Validates**: Retry loop obeys config.
  - **Pass criteria**: Retry count matches config, success result returned.

#### Integration Tests

##### describe('AgentRunner - recorder scenarios')
- **`it('replays simple-file-edit fixture producing complete RunResult')`**
  - **Components**: AgentRunner, ClaudeSdkReplay, ContextManager.
  - **Pass criteria**: RunResult equals recorded output; all hooks captured.

- **`it('captures git diff and file changes during multi-file refactor scenario')`**
  - **Pass criteria**: RunResult `files` contains expected diff summary.

- **`it('collects tool timeline with correlated Pre/Post events')`**
  - **Pass criteria**: Tool timeline matches fixture timeline.

- **`it('enforces cost budget by aborting run when limit exceeded')`**
  - **Pass criteria**: RunResult `status='aborted'` and budget log entry appended.

- **`it('handles SDK timeout by triggering configured fallback strategy')`**
  - **Pass criteria**: Timeout results in fallback RunResult, error recorded.

- **`it('supports rerun after failure preserving previous state')`**
  - **Pass criteria**: Second run includes history of first failure.

#### E2E Tests

##### describe('AgentRunner - workflows')
- **`it('executes plan-review workflow until judge passes recorded rubric')`**
  - **Validates**: Full run with judge gating.
  - **Journey**: Run agent, judge result, rerun if fail.
  - **Pass criteria**: Workflow completes with RunResult flagged success.

- **`it('performs error correction loop after lint failure scenario')`**
  - **Validates**: Loop through failure, correction, success.
  - **Pass criteria**: Timeline shows fail → fix → success sequence.

---

#### Module: ContextManager
**Location**: `src/agent/ContextManager.ts`\
**Dependencies**: Hook capture, git utilities, storage, tool processors.\
**Complexity**: High

### Test Coverage Strategy
- **Unit Tests**: 16
  - Focus on state initialization, hook processing, partial results, git detection, graceful degradation.
- **Integration Tests**: 5
  - Focus on interplay with AgentRunner and storage.
- **E2E Tests**: Covered by AgentRunner workflows.

### Test Scaffolds

#### Unit Tests

##### describe('ContextManager - initialization')
- **`it('sets up empty collections for hooks, tools, files, timeline')`**
  - **Validates**: Baseline state.
  - **Pass criteria**: All collections empty.

- **`it('detects git repository using detectGitRepo helper')`**
  - **Validates**: Git detection logic executed on construct.
  - **Pass criteria**: `gitDetected=true` when repo present.

##### describe('ContextManager - processHookEvent')
- **`it('records PreToolUse and PostToolUse with correlation IDs')`**
  - **Validates**: Hook correlation.
  - **Pass criteria**: Tool map includes entry with Pre/Post pair.

- **`it('appends Notification hooks to timeline with timestamps')`**
  - **Validates**: Timeline updates.
  - **Pass criteria**: Timeline entries sorted ascending.

- **`it('handles missing PostToolUse by marking hookCaptureStatus=partial')`**
  - **Validates**: Graceful degradation.
  - **Pass criteria**: State reflects partial status, warning emitted.

##### describe('ContextManager - partial results')
- **`it('returns latest RunResult snapshot without mutating state')`**
  - **Validates**: `getPartialResult`.
  - **Pass criteria**: Repeated calls return same object reference.

- **`it('provides partial result during watcher execution')`**
  - **Validates**: Partial retrieval safe mid-run.
  - **Pass criteria**: Watcher receives partial data without errors.

##### describe('ContextManager - error handling')
- **`it('captures hook processing errors and logs structured warning')`**
  - **Validates**: Error logging path.
  - **Pass criteria**: Warning logged and status flagged.

- **`it('falls back to minimal RunResult when storage unavailable')`**
  - **Validates**: Storage failure resilience.
  - **Pass criteria**: RunResult contains minimal data, error recorded.

- **`it('deduplicates repeated hook IDs to prevent double counting')`**
  - **Validates**: Idempotency.
  - **Pass criteria**: Duplicate events ignored.

##### describe('ContextManager - git state capture')
- **`it('captures git status before and after run')`**
  - **Validates**: Git state snapshots.
  - **Pass criteria**: Pre/post states stored with diff summary.

- **`it('records tracked files with before/after content hashes')`**
  - **Validates**: File snapshot creation.
  - **Pass criteria**: Files map contains hashes referencing content store.

#### Integration Tests

##### describe('ContextManager - integration with AgentRunner')
- **`it('processes full hook stream from recorder scenario')`**
  - **Pass criteria**: Hook timeline matches fixture exactly.

- **`it('persists RunBundle metadata to storage on finalize')`**
  - **Pass criteria**: Storage fixture receives bundle with expected IDs.

- **`it('updates file tracker using recorded git diffs')`**
  - **Pass criteria**: File entries align with diff.

- **`it('emits timeline entries in chronological order even with out-of-order hooks')`**
  - **Pass criteria**: Timeline sorted.

- **`it('reports storage errors and marks runResult.status=partial')`**
  - **Pass criteria**: RunResult flagged partial, warning logged once.

---

#### Module: Hook Capture System\n**Location**: `src/agent/hooks/`\\n**Dependencies**: ContextManager, tool correlation, logging.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 9
  - Focus on ordering, correlation, resilience.
- **Integration Tests**: 3
  - Replay recorded hook streams verifying determinism.

### Test Scaffolds

#### Unit Tests

##### describe('HookCapture - sequence enforcement')
- **`it('rejects PostToolUse without matching PreToolUse and logs warning')`**
  - **Validates**: Error path for unmatched Post events.
  - **Fixtures**: Synthetic hook payloads lacking Pre event.
  - **Pass criteria**: Throws `HookSequenceError`; warning logged once.

- **`it('assigns monotonically increasing correlation IDs per tool invocation')`**
  - **Validates**: Correlation ID generation.
  - **Fixtures**: PreToolUse events with unique timestamps.
  - **Pass criteria**: IDs increment and map stored in state.

##### describe('HookCapture - resilience')
- **`it('continues processing after malformed hook while recording partial status')`**
  - **Validates**: Graceful degradation policy.
  - **Fixtures**: Hook missing required fields.
  - **Pass criteria**: Hook skipped, `hookCaptureStatus` set to partial.

- **`it('deduplicates hooks with identical sequence numbers')`**
  - **Validates**: Idempotency.
  - **Fixtures**: Duplicate event input.
  - **Pass criteria**: Only one entry stored; duplicate logged.

##### describe('HookCapture - timeline ordering')
- **`it('orders events by timestamp even when received out of order')`**
  - **Validates**: Sorting logic.
  - **Fixtures**: Events with decreasing timestamps.
  - **Pass criteria**: Timeline output sorted ascending.

- **`it('supports notification hooks without tool correlation')`**
  - **Validates**: Non-tool events still recorded.
  - **Pass criteria**: Notification appended with type metadata.

- **`it('marks session timeout hook and triggers recovery path')`**
  - **Validates**: Timeout handling within hook capture.
  - **Fixtures**: Session timeout payload.
  - **Pass criteria**: Timeout event flagged, recovery callback invoked.

#### Integration Tests

##### describe('HookCapture - recorder streams')
- **`it('replays successful tool scenario and matches expected timeline order')`**
  - **Validates**: Deterministic replay.
  - **Pass criteria**: Timeline equals fixture snapshot.

- **`it('captures tool failure sequence preserving error metadata')`**
  - **Validates**: Error payload propagation.
  - **Pass criteria**: Failure record contains error info from Post hook.

- **`it('handles session timeout fixture producing partial status and warning')`**
  - **Validates**: Timeout handling end-to-end.
  - **Pass criteria**: Status partial, warning logged exactly once.

---

#### Module: RunResult Population\n**Location**: `src/agent/results/`\\n**Dependencies**: ContextManager, cost tracking, tool timeline, git snapshots.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 7
  - Focus on field derivation, status transitions, serialization.
- **Integration Tests**: 2
  - Focus on compatibility with judge and reporters.

### Test Scaffolds

#### Unit Tests

##### describe('RunResultBuilder - summary population')
- **`it('derives summary from latest agent message and success state')`**
  - **Validates**: Summary generation.
  - **Fixtures**: Context snapshot with final assistant message.
  - **Pass criteria**: RunResult summary equals expected string.

- **`it('sets status=failed when execution error present')`**
  - **Validates**: Status transitions.
  - **Pass criteria**: Status field matches failure, error metadata stored.

##### describe('RunResultBuilder - hook completeness')
- **`it('computes hook completeness ratio from captured events')`**
  - **Validates**: Completeness metric.
  - **Pass criteria**: Ratio equals captured/expected.

- **`it('marks hookCaptureStatus=partial when missing events detected')`**
  - **Validates**: Degradation propagation.
  - **Pass criteria**: Status partial, warnings appended.

##### describe('RunResultBuilder - metadata aggregation')
- **`it('includes git metadata when git capture succeeds')`**
  - **Validates**: Git fields populate.
  - **Fixtures**: Git snapshot fixture.
  - **Pass criteria**: RunResult.git contains branch, commit, diff summary.

- **`it('captures cost usage and totals from cost tracker')`**
  - **Validates**: Cost integration.
  - **Pass criteria**: `usage.tokens` and `cost.usd` match tracker data.

- **`it('serializes attachments metadata with content hashes')`**
  - **Validates**: Attachment referencing.
  - **Pass criteria**: Attachment entries include hash + path.

#### Integration Tests

##### describe('RunResultBuilder - downstream consumers')
- **`it('produces RunResult accepted by judge without mutation')`**
  - **Components**: RunResultBuilder, judge fixture.
  - **Pass criteria**: Judge returns result; original RunResult unchanged.

- **`it('integrates with reporters producing consistent summaries')`**
  - **Components**: RunResultBuilder, Terminal reporter.
  - **Pass criteria**: Reporter output matches RunResult data fields.

---

### 4.3 Storage System

#### Module: RunBundle Disk Storage
**Location**: `src/storage/RunBundleStore.ts`\
**Dependencies**: Node fs/promises, content-addressed store, checksum utilities, cleanup policy.\
**Complexity**: High

### Test Coverage Strategy
- **Unit Tests**: 12
  - Focus on atomic writes, metadata integrity, deduplication, corruption detection, config adherence.
  - Mocking: fs via memfs, checksum utilities.
- **Integration Tests**: 5
  - Focus on real filesystem writes (tmp dir), interplay with content store and cleanup.
- **E2E Tests**: 1
  - Scenario: Full cleanup script removing stale bundles while respecting protected markers.

### Test Scaffolds

#### Unit Tests

##### describe('RunBundleStore - write operations')
- **`it('writes metadata and payload atomically using temp files then rename')`**
  - **Validates**: Atomic write contract.
  - **Fixtures**: memfs mock verifying rename occurs after write.
  - **Edge cases**: Failure during write cleans up temp files.
  - **Pass criteria**: Only final file exists after success; temp removed.

- **`it('rejects write when required fields missing from RunBundle')`**
  - **Validates**: Input validation.
  - **Pass criteria**: Throws `RunBundleValidationError` listing missing fields.

##### describe('RunBundleStore - read operations')
- **`it('loads bundle by ID returning lazy file handles')`**
  - **Validates**: Read path returns metadata and lazy loaders.
  - **Fixtures**: Pre-seeded bundle.
  - **Pass criteria**: Accessor functions fetch data on demand.

- **`it('throws descriptive error when bundle not found')`**
  - **Validates**: Error messaging.
  - **Pass criteria**: Error includes bundle ID and storage path.

##### describe('RunBundleStore - deduplication')
- **`it('stores artifacts using content-addressed keys shared across bundles')`**
  - **Validates**: Dedup logic.
  - **Pass criteria**: Two bundles referencing same file use identical content hash.

- **`it('increments reference counts for shared content and decrements on delete')`**
  - **Validates**: Reference tracking.
  - **Pass criteria**: After deletion, count decremented and file removed when zero.

##### describe('RunBundleStore - corruption detection')
- **`it('verifies checksums on read and marks bundle corrupted when mismatch')`**
  - **Validates**: Integrity checks.
  - **Pass criteria**: Read throws `RunBundleIntegrityError`, bundle flagged.

- **`it('stores checksum metadata alongside artifacts')`**
  - **Validates**: Metadata persistence.
  - **Pass criteria**: Metadata contains `sha256` field per artifact.

##### describe('RunBundleStore - configuration')
- **`it('respects storage path defined in config including env overrides')`**
  - **Validates**: Config integration.
  - **Pass criteria**: Files written to configured directory.

- **`it('enforces max bundle size and rejects oversized payloads')`**
  - **Validates**: Size check.
  - **Pass criteria**: Throws `RunBundleSizeExceededError`.

##### describe('RunBundleStore - logging')
- **`it('logs structured entry on successful persistence with bundle stats')`**
  - **Validates**: Logging contract.
  - **Pass criteria**: Logger receives message containing file count, total size.

- **`it('logs warning and retains temp data when cleanup fails')`**
  - **Validates**: Failure path.
  - **Pass criteria**: Warning includes remediation instructions.

#### Integration Tests

##### describe('RunBundleStore - filesystem integration')
- **`it('persists recorder RunResult bundle to temp directory and reloads successfully')`**
  - **Real vs Mock**: Real fs (tmp dir), real content store, replay data.
  - **Pass criteria**: Reload equals original RunResult.

- **`it('streams large attachment lazily without loading entire file into memory')`**
  - **Pass criteria**: Memory usage below threshold; streaming callback invoked.

- **`it('handles concurrent writes using lock file to avoid corruption')`**
  - **Pass criteria**: Two writes succeed sequentially without race conditions.

- **`it('executes cleanup policy removing bundles older than maxAgeDays')`**
  - **Pass criteria**: Old bundles deleted, protected `.vibe-keep` preserved.

- **`it('halts cleanup when minFreeDiskMb threshold satisfied early')`**
  - **Pass criteria**: Cleanup stops once disk space restored, logs summary.

#### E2E Tests

##### describe('RunBundleStore - cleanup workflow')
- **`it('runs cleanupBundles CLI respecting protected bundles and manual overrides')`**
  - **Journey**: Create bundles, mark protected, run CLI.
  - **Pass criteria**: Only eligible bundles removed; summary matches counts.

---

#### Module: Content-Addressed File Storage\n**Location**: `src/storage/contentStore.ts`\\n**Dependencies**: Crypto, fs, compression utils.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 8
  - Focus on hashing, deduplication, compression, error handling.
- **Integration Tests**: 2
  - Interaction with RunBundleStore for shared content.

### Test Scaffolds

#### Unit Tests

##### describe('contentStore - put')
- **`it('generates deterministic hash for identical content using sha256')`**
  - **Validates**: Hashing reproducibility.
  - **Fixtures**: Two streams with same content.
  - **Pass criteria**: Hashes identical and stored once.

- **`it('rejects files exceeding max size with descriptive error')`**
  - **Validates**: Size enforcement.
  - **Pass criteria**: Throws `ContentTooLargeError` with limit info.

- **`it('stores compressed variant when compression enabled')`**
  - **Validates**: Compression path.
  - **Pass criteria**: Stored file smaller and metadata notes compression.

##### describe('contentStore - get')
- **`it('streams content without loading entire file into memory')`**
  - **Validates**: Streaming API.
  - **Fixtures**: Large file stub measuring memory usage.
  - **Pass criteria**: Stream consumed incrementally.

- **`it('throws ContentNotFoundError when hash missing')`**
  - **Validates**: Error path.
  - **Pass criteria**: Error includes hash and storage path.

##### describe('contentStore - maintenance')
- **`it('garbage collects blobs when reference count zero')`**
  - **Validates**: Cleanup.
  - **Pass criteria**: Blob removed from disk and index.

- **`it('updates reference counts atomically during concurrent put operations')`**
  - **Validates**: Concurrency safety.
  - **Pass criteria**: Count reflects total references after parallel writes.

- **`it('restores metadata from index file on initialization')`**
  - **Validates**: Startup bootstrap.
  - **Pass criteria**: Index reloaded with previous entries.

#### Integration Tests

##### describe('contentStore - RunBundle integration')
- **`it('shares physical blob between two bundles referencing same content')`**
  - **Validates**: Dedup with RunBundleStore.
  - **Pass criteria**: Disk contains single file; both bundles reference same hash.

- **`it('removes blob once all referencing bundles deleted')`**
  - **Validates**: Reference counting end-to-end.
  - **Pass criteria**: After deletion, blob absent and index updated.

---

#### Module: Lazy Loading Mechanism\n**Location**: `src/storage/lazyFile.ts`\\n**Dependencies**: fs, stream utilities.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 6
  - Focus on deferred open, caching, error propagation, streaming conversions.
- **Integration Tests**: 1
  - Validate usage in HTML reporter attachments.

### Test Scaffolds

#### Unit Tests

##### describe('lazyFile - deferred access')
- **`it('does not touch filesystem until accessor invoked')`**
  - **Validates**: Lazy evaluation.
  - **Fixtures**: fs spy verifying no reads before call.
  - **Pass criteria**: No fs calls pre-access; single read on demand.

- **`it('caches file contents on repeated text() calls')`**
  - **Validates**: Caching behavior.
  - **Pass criteria**: Second call avoids fs read.

##### describe('lazyFile - streaming')
- **`it('exposes toStream returning readable stream for large files')`**
  - **Validates**: Stream conversion.
  - **Pass criteria**: Stream emits expected chunks; closes gracefully.

- **`it('supports toBuffer with size guard to prevent OOM')`**
  - **Validates**: Buffer conversion with limits.
  - **Pass criteria**: Exceeds limit throws `LazyFileSizeError`.

##### describe('lazyFile - error handling')
- **`it('propagates fs errors with contextual path information')`**
  - **Validates**: Error wrapping.
  - **Pass criteria**: Error message includes file path.

- **`it('allows manual dispose to release cached data')`**
  - **Validates**: Dispose semantics.
  - **Pass criteria**: After dispose, next access re-reads file.

#### Integration Tests

##### describe('lazyFile - HTML reporter integration')
- **`it('embeds attachment lazily without reading entire file during generation')`**
  - **Validates**: Reporter usage.
  - **Pass criteria**: Reporter registers lazy reference; file read deferred until client request.

---

#### Module: Cleanup Policies\n**Location**: `src/storage/cleanup.ts`\\n**Dependencies**: RunBundleStore, config, fs stats.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 5
  - Focus on date filtering, disk threshold, keep markers, manual overrides, dry run option.
- **Integration Tests**: 2
  - Execute cleanup against temp directories with sample bundles.

### Test Scaffolds

#### Unit Tests

##### describe('cleanup - eligibility checks')
- **`it('flags bundles older than maxAgeDays for deletion')`**
  - **Validates**: Age filtering.
  - **Fixtures**: Bundle metadata with timestamps.
  - **Pass criteria**: Only bundles beyond threshold marked.

- **`it('skips bundles containing .vibe-keep marker')`**
  - **Validates**: Protected bundle handling.
  - **Pass criteria**: Protected bundle returns false for deletion.

##### describe('cleanup - disk pressure logic')
- **`it('continues deleting until minFreeDiskMb satisfied')`**
  - **Validates**: Disk threshold loop.
  - **Pass criteria**: Cleanup stops once free space threshold reached.

- **`it('supports dryRun mode emitting plan without deleting')`**
  - **Validates**: Dry run behavior.
  - **Pass criteria**: No deletions performed; plan reported.

##### describe('cleanup - overrides')
- **`it('respects manual override maxAgeDays passed to cleanupBundles')`**
  - **Validates**: Override precedence.
  - **Pass criteria**: Provided option supersedes config default.

#### Integration Tests

##### describe('cleanup - filesystem execution')
- **`it('deletes eligible bundles and logs summary with counts')`**
  - **Validates**: End-to-end deletion.
  - **Pass criteria**: Files removed; log includes deleted/kept counts.

- **`it('retains protected bundles and returns skipped list')`**
  - **Validates**: Keep markers in practice.
  - **Pass criteria**: Protected bundles remain; report lists them as skipped.

---

### 4.4 Judge System

#### Module: Rubric Validation\n**Location**: `src/judge/rubric.ts`\\n**Dependencies**: zod, Rubric interfaces, config defaults.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 9
  - Focus on schema success, failure messaging, default injection, custom criteria.
- **Integration Tests**: 2
  - Focus on pipeline with judge execution using validated rubrics.

### Test Scaffolds

#### Unit Tests

##### describe('RubricSchema - structured rubrics')
- **`it('accepts structured rubric with criteria array and optional threshold')`**
  - **Validates**: Happy path for structured rubric.
  - **Pass criteria**: Validation passes, defaults applied.

- **`it('rejects rubric missing criteria names with descriptive error path')`**
  - **Validates**: Error messaging includes pointer to missing field.
  - **Pass criteria**: Error path `criteria[0].name`.

##### describe('RubricSchema - freeform rubrics')
- **`it('allows freeform rubric with instructions string')`**
  - **Validates**: Freeform branch.
  - **Pass criteria**: Schema returns parsed object with defaults.

- **`it('rejects freeform rubric missing instructions')`**
  - **Validates**: Required field enforcement.
  - **Pass criteria**: Error message includes `instructions`.

##### describe('RubricSchema - defaults & overrides')
- **`it('injects default model when none provided using DEFAULT_MODEL')`**
  - **Validates**: Default injection.
  - **Pass criteria**: Result includes default model constant.

- **`it('supports custom criteria metadata and preserves order')`**
  - **Validates**: Criteria array order maintained.
  - **Pass criteria**: Output order equals input.

- **`it('validates passThreshold within 0-1 range')`**
  - **Validates**: Threshold boundaries.
  - **Pass criteria**: Values outside range produce descriptive error.

- **`it('produces JSON schema for rubric when requested')`**
  - **Validates**: Schema export.
  - **Pass criteria**: JSON schema contains criteria definitions.

- **`it('marks deprecated fields with warning metadata')`**
  - **Validates**: Deprecation handling.
  - **Pass criteria**: Warning array includes field name.

#### Integration Tests

##### describe('Rubric validation integration')
- **`it('passes validated rubric into judge() without mutation')`**
  - **Validates**: Pipeline flow.
  - **Pass criteria**: Input rubric unchanged, judge receives same reference.

- **`it('prevents judge execution when validation fails and surfaces error')`**
  - **Validates**: Guard against invalid rubrics.
  - **Pass criteria**: judge not invoked; error thrown with schema issues.

---

#### Module: LLM Judge Execution\n**Location**: `src/judge/judge.ts`\\n**Dependencies**: Claude SDK bridge, rubric validation, prompt formatter, result parser.\\n**Complexity**: High

### Test Coverage Strategy
- **Unit Tests**: 11
  - Focus on prompt assembly, message ordering, option merging, error handling, retry policy.
- **Integration Tests**: 4
  - Use recorder fixtures to evaluate real LLM outputs.
- **E2E Tests**: 1
  - Judge gating inside workflow loop.

### Test Scaffolds

#### Unit Tests

##### describe('judge - prompt formation')
- **`it('combines rubric criteria and instructions into Claude prompt format')`**
  - **Validates**: Prompt builder includes rubric name, criteria, instructions.
  - **Fixtures**: Structured rubric, instructions string.
  - **Pass criteria**: Prompt array matches spec ordering.

- **`it('applies DEFAULT_MODEL when model not provided')`**
  - **Validates**: Model fallback.
  - **Pass criteria**: Options passed to SDK include default model.

##### describe('judge - result parsing')
- **`it('parses structured JSON response using provided resultFormat schema')`**
  - **Validates**: Schema-driven parsing.
  - **Pass criteria**: Parsed result typed to schema, errors thrown for mismatch.

- **`it('falls back to textual summary when schema parsing fails')`**
  - **Validates**: Graceful fallback.
  - **Pass criteria**: Returns DefaultJudgmentResult with failure reason.

##### describe('judge - error handling')
- **`it('wraps SDK errors in JudgmentFailedError with context metadata')`**
  - **Validates**: Error propagation.
  - **Pass criteria**: Error includes runId, rubric name.

- **`it('retries retryable errors respecting maxRetry count')`**
  - **Validates**: Retry policy.
  - **Pass criteria**: Retry invoked expected times; final success recorded.

- **`it('aborts when budget enforcement denies further LLM calls')`**
  - **Validates**: Budget integration.
  - **Pass criteria**: Throws with message referencing budget.

##### describe('judge - attachments and metadata')
- **`it('includes attachments metadata in returned JudgeResult')`**
  - **Validates**: Attachment pass-through.
  - **Pass criteria**: Attachments accessible via result.attachments.

- **`it('records token usage and cost into RunResult linkage')`**
  - **Validates**: Usage tracking.
  - **Pass criteria**: RunResult usage increments by returned tokens.

- **`it('supports streaming partial responses for long outputs')`**
  - **Validates**: Streaming support.
  - **Pass criteria**: Async generator yields partial text and final result aggregated.

- **`it('emits telemetry event per judgment with criteria summary')`**
  - **Validates**: Telemetry instrumentation.
  - **Pass criteria**: Telemetry spy receives event.

#### Integration Tests

##### describe('judge - recorder scenarios')
- **`it('replays recorded successful judgment producing pass result')`**
  - **Validates**: Replay integration.
  - **Pass criteria**: Result matches fixture verdict.

- **`it('handles recorded failure scenario returning failure summary')`**
  - **Validates**: Failure path.
  - **Pass criteria**: Result indicates fail with reasons.

- **`it('parses custom schema in recorder scenario producing typed output')`**
  - **Validates**: Custom schema support.
  - **Pass criteria**: Output matches custom type.

- **`it('records judgment metadata into RunBundle artifacts')`**
  - **Validates**: Storage integration.
  - **Pass criteria**: RunBundle includes judgment entry referencing rubric.

#### E2E Tests

##### describe('judge - workflow loop')
- **`it('controls until() loop termination based on pass/fail result')`**
  - **Journey**: Agent run → judge → rerun until pass.
  - **Pass criteria**: Loop stops when judge returns pass; max iterations not exceeded.

---

#### Module: JudgeResult Handling\n**Location**: `src/judge/result.ts`\\n**Dependencies**: Rubric types, RunResult references, reporters.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 7
  - Focus on serialization, pass/fail state, criteria mapping, attachments.
- **Integration Tests**: 2
  - Integration with reporters and VibeTestContext.

### Test Scaffolds

#### Unit Tests

##### describe('JudgeResult - state helpers')
- **`it('returns true for isPass when score meets passThreshold')`**
  - **Validates**: Pass/fail helper logic.
  - **Pass criteria**: `isPass` true, `status='pass'`.

- **`it('calculates aggregate score from criteria array')`**
  - **Validates**: Scoring logic.
  - **Pass criteria**: Weighted score matches expected value.

##### describe('JudgeResult - serialization')
- **`it('serializes to JSON including criteria breakdown and summary')`**
  - **Validates**: JSON export.
  - **Pass criteria**: JSON includes criteria entries and attachments metadata.

- **`it('preserves attachment references during serialization/deserialization')`**
  - **Validates**: Attachment integrity.
  - **Pass criteria**: After round-trip, attachments identical.

##### describe('JudgeResult - error reporting')
- **`it('captures failure reasons and recommended actions')`**
  - **Validates**: Failure metadata.
  - **Pass criteria**: `failureReasons` populated with rubric criteria names.

- **`it('links to RunResult via runId for traceability')`**
  - **Validates**: Cross-linking.
  - **Pass criteria**: `runId` stored and accessible.

- **`it('supports custom fields without dropping unknown keys')`**
  - **Validates**: Extensibility.
  - **Pass criteria**: Custom fields remain after normalization.

#### Integration Tests

##### describe('JudgeResult - consumers')
- **`it('renders in HTML reporter judgment section with correct formatting')`**
  - **Validates**: Reporter integration.
  - **Pass criteria**: HTML contains criteria table and summary.

- **`it('stores judgment attachments in VibeTestContext for follow-up assertions')`**
  - **Validates**: Context integration.
  - **Pass criteria**: Context `judgments` array contains attachments accessible by tests.

---

### 4.5 Reporters

#### Module: Terminal Cost Reporter\n**Location**: `src/reporters/TerminalCostReporter.ts`\\n**Dependencies**: Console formatting, cost tracking, chalk (or equivalent).\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 6
  - Focus on formatting, accumulation, zero-cost handling, warning output.
- **Integration Tests**: 2
  - Run reporter against RunBundle fixtures verifying console output snapshot.

### Test Scaffolds

#### Unit Tests

##### describe('TerminalCostReporter - formatting')
- **`it('prints per-run cost table with aligned columns')`**
  - **Validates**: Table formatting.
  - **Pass criteria**: Output matches snapshot with column alignment.

- **`it('highlights over-budget runs in red with warning icon')`**
  - **Validates**: Warning styling.
  - **Pass criteria**: Output includes color codes when TTY true.

##### describe('TerminalCostReporter - accumulation')
- **`it('aggregates total tokens and cost across runs')`**
  - **Validates**: Summation logic.
  - **Pass criteria**: Totals equal sum of individual runs.

- **`it('handles zero-cost runs without dividing by zero')`**
  - **Validates**: Edge case.
  - **Pass criteria**: Output shows $0.00 without errors.

##### describe('TerminalCostReporter - environment behavior')
- **`it('disables color when TTY not detected')`**
  - **Validates**: TTY detection.
  - **Pass criteria**: Output lacks ANSI codes when `isTTY=false`.

- **`it('logs warning when cost data missing for a run')`**
  - **Validates**: Missing data handling.
  - **Pass criteria**: Warning message references runId.

#### Integration Tests

##### describe('TerminalCostReporter - RunBundle playback')
- **`it('generates summary for recorder scenario matching snapshot')`**
  - **Validates**: End-to-end output.
  - **Pass criteria**: Console snapshot equals baseline.

- **`it('prints cumulative totals after multiple runs with budget alert')`**
  - **Validates**: Multi-run scenario.
  - **Pass criteria**: Output includes final totals and budget warning once.

---

#### Module: HTML Reporter\n**Location**: `src/reporters/HtmlReporter.ts`\\n**Dependencies**: RunBundleStore, template renderer, lazy files, asset pipeline.\\n**Complexity**: High

### Test Coverage Strategy
- **Unit Tests**: 10
  - Focus on layout generation, asset linking, run filtering, accessibility attributes.
- **Integration Tests**: 3
  - Snapshot entire HTML output for sample bundles.

### Test Scaffolds

#### Unit Tests

##### describe('HtmlReporter - layout')
- **`it('renders run summary cards with status badges and cost totals')`**
  - **Validates**: Summary layout.
  - **Pass criteria**: Rendered HTML includes cards with expected classes.

- **`it('includes accessibility landmarks and aria labels')`**
  - **Validates**: Accessibility compliance.
  - **Pass criteria**: Document contains `role="main"`, labelled sections.

##### describe('HtmlReporter - assets')
- **`it('links CSS and JS assets using hashed filenames')`**
  - **Validates**: Asset pipeline integration.
  - **Pass criteria**: Output references hashed asset names.

- **`it('embeds inline critical CSS when configured')`**
  - **Validates**: Inline asset option.
  - **Pass criteria**: Inline `<style>` present when option true.

##### describe('HtmlReporter - run filtering')
- **`it('filters runs by status when filter applied')`**
  - **Validates**: Filtering logic.
  - **Pass criteria**: Only matching runs rendered.

- **`it('supports search input to highlight matching text')`**
  - **Validates**: Search behavior.
  - **Pass criteria**: Matching text wrapped with highlight span.

##### describe('HtmlReporter - attachments')
- **`it('embeds small attachments inline using data URIs')`**
  - **Validates**: Inline embedding.
  - **Pass criteria**: Base64 data URI included for small file.

- **`it('links large attachments via lazy file download endpoints')`**
  - **Validates**: Lazy file integration.
  - **Pass criteria**: Link points to lazy file route.

##### describe('HtmlReporter - timelines')
- **`it('renders hook timeline with chronological ordering and icons')`**
  - **Validates**: Timeline rendering.
  - **Pass criteria**: Timeline entries sorted; icons match event types.

- **`it('shows judge results with rubric criteria table')`**
  - **Validates**: Judgment section.
  - **Pass criteria**: Table rows equal criteria count.

#### Integration Tests

##### describe('HtmlReporter - snapshot outputs')
- **`it('generates HTML for simple-file-edit scenario matching snapshot')`**
  - **Validates**: Baseline output.
  - **Pass criteria**: Snapshot diff clean.

- **`it('renders multi-run report with filters and attachments correctly')`**
  - **Validates**: Complex scenario.
  - **Pass criteria**: Snapshot matches expected markup.

- **`it('supports dark mode toggle when configuration enabled')`**
  - **Validates**: Theming support.
  - **Pass criteria**: Snapshot includes dark mode toggle component.

---

#### Module: Report Generation & Artifacts\n**Location**: `src/reporters/generation.ts`\\n**Dependencies**: RunBundleStore, fs, path utilities, cleanup policies.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 8
  - Focus on artifact naming, directory structure, concurrency safety, cleanup.
- **Integration Tests**: 2
  - Validate interplay with RunBundleStore.

### Test Scaffolds

#### Unit Tests

##### describe('ReportGeneration - naming & structure')
- **`it('generates slugified directory names including suite and timestamp')`**
  - **Validates**: Naming convention.
  - **Pass criteria**: Directory path matches pattern `suite-YYYYMMDD-HHmmss`.

- **`it('avoids collisions by appending counter when directory exists')`**
  - **Validates**: Collision handling.
  - **Pass criteria**: Second run uses suffix `-2`.

##### describe('ReportGeneration - manifest')
- **`it('writes artifact manifest JSON listing all generated files')`**
  - **Validates**: Manifest creation.
  - **Pass criteria**: Manifest contains entries for HTML, assets, attachments.

- **`it('updates manifest with relative paths for portability')`**
  - **Validates**: Relative path requirement.
  - **Pass criteria**: Manifest paths start with `./`.

##### describe('ReportGeneration - cleanup & concurrency')
- **`it('removes stale artifacts when exceed retention count')`**
  - **Validates**: Cleanup policy.
  - **Pass criteria**: Old directories deleted, latest retained.

- **`it('uses file locks to prevent concurrent writes to same directory')`**
  - **Validates**: Concurrency safety.
  - **Pass criteria**: Only one process writes; others wait/fail gracefully.

- **`it('handles disk write failures by cleaning up partial directories')`**
  - **Validates**: Error handling.
  - **Pass criteria**: Partial directory removed; error includes path.

- **`it('records artifact metadata back into RunBundleStore')`**
  - **Validates**: Storage integration.
  - **Pass criteria**: RunBundle metadata updated with artifact links.

#### Integration Tests

##### describe('ReportGeneration - RunBundle integration')
- **`it('generates report artifacts for recorded run and verifies manifest references')`**
  - **Validates**: End-to-end generation.
  - **Pass criteria**: Manifest entries exist and files accessible.

- **`it('executes cleanup policy after artifact generation removing old directories')`**
  - **Validates**: Cleanup interplay.
  - **Pass criteria**: Number of directories reduced to retention count.

---

### 4.6 Matrix Testing

#### Module: defineTestSuite\n**Location**: `src/matrix/defineTestSuite.ts`\\n**Dependencies**: vibeTest, matrix product generator, configuration overrides.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 7
  - Focus on option matrix expansion, custom filters, suite metadata, error handling.
- **Integration Tests**: 2
  - Execute generated suites verifying vibeTest integration.

### Test Scaffolds

#### Unit Tests

##### describe('defineTestSuite - expansion')
- **`it('creates tests for every combination of matrix dimensions')`**
  - **Validates**: Cartesian expansion.
  - **Pass criteria**: Number of generated tests equals product of dimension lengths.

- **`it('applies filter function to skip undesired combinations')`**
  - **Validates**: Filtering support.
  - **Pass criteria**: Filtered combinations not scheduled.

##### describe('defineTestSuite - metadata')
- **`it('names generated tests with readable titles including parameter labels')`**
  - **Validates**: Naming convention.
  - **Pass criteria**: Test titles contain parameter key/value.

- **`it('propagates suite-level timeout overrides to child tests')`**
  - **Validates**: Timeout handling.
  - **Pass criteria**: Child tests receive configured timeout.

##### describe('defineTestSuite - error handling')
- **`it('throws descriptive error when matrix contains empty dimension')`**
  - **Validates**: Validation guard.
  - **Pass criteria**: Error message references dimension key.

- **`it('supports async setup hook executed before each generated test')`**
  - **Validates**: Hook integration.
  - **Pass criteria**: Setup invoked for every combination.

- **`it('merges per-combination overrides into vibeTest context options')`**
  - **Validates**: Options merging.
  - **Pass criteria**: Provided overrides accessible within test body.

#### Integration Tests

##### describe('defineTestSuite - vibeTest integration')
- **`it('generates and runs suite executing vibeTest for each combination')`**
  - **Validates**: End-to-end integration.
  - **Pass criteria**: All tests run and record expected results.

- **`it('produces reporter metadata grouping runs by suite and parameters')`**
  - **Validates**: Reporting integration.
  - **Pass criteria**: RunBundle includes suite metadata.

---

#### Module: Cartesian Product Generation\n**Location**: `src/matrix/product.ts`\\n**Dependencies**: None beyond stdlib.\\n**Complexity**: Low

### Test Coverage Strategy
- **Unit Tests**: 5
  - Focus on empty dimensions, single dimension, duplicates, ordering, large combinations performance.
- **Integration Tests**: Not required (covered via defineTestSuite).

### Test Scaffolds

#### Unit Tests

##### describe('cartesianProduct')
- **`it('returns empty array when any dimension empty')`**
  - **Validates**: Early exit rule.
  - **Pass criteria**: Output `[]`.

- **`it('returns same values for single dimension preserving order')`**
  - **Validates**: Identity case.
  - **Pass criteria**: Output equals input array of arrays.

- **`it('preserves ordering of combinations lexicographically')`**
  - **Validates**: Deterministic ordering.
  - **Pass criteria**: Sequence matches documented order.

- **`it('handles duplicate values without deduping')`**
  - **Validates**: Duplicate support.
  - **Pass criteria**: Output includes duplicates as distinct combos.

- **`it('throws error when total combinations exceed limit to prevent explosion')`**
  - **Validates**: Safety limit.
  - **Pass criteria**: Throws `MatrixTooLargeError` with limit details.

---

### 4.7 Configuration

#### Module: defineVibeConfig\n**Location**: `src/config/defineVibeConfig.ts`\\n**Dependencies**: Configuration schema, environment loader, defaults.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 9
  - Focus on merging defaults, environment overrides, immutability, plugin registration.
- **Integration Tests**: 3
  - Ensure config flows into vibeTest and AgentRunner.

### Test Scaffolds

#### Unit Tests

##### describe('defineVibeConfig - defaults')
- **`it('merges provided options with DEFAULT_CONFIG values')`**
  - **Validates**: Default merging.
  - **Pass criteria**: Missing fields populated with defaults.

- **`it('supports functional config returning derived object')`**
  - **Validates**: Functional override support.
  - **Pass criteria**: Function executed with base config.

##### describe('defineVibeConfig - environment overrides')
- **`it('applies environment-specific overrides when NODE_ENV matches key')`**
  - **Validates**: Env override logic.
  - **Pass criteria**: Env-specific values override base.

- **`it('throws descriptive error when override references unknown environment')`**
  - **Validates**: Validation guard.
  - **Pass criteria**: Error message includes environment name.

##### describe('defineVibeConfig - immutability & plugins')
- **`it('returns frozen config object to prevent mutation')`**
  - **Validates**: Immutability.
  - **Pass criteria**: `Object.isFrozen` true; mutations throw.

- **`it('registers plugin hooks and executes on config load')`**
  - **Validates**: Plugin integration.
  - **Pass criteria**: Plugin spy invoked with config context.

- **`it('allows plugin to augment test context options')`**
  - **Validates**: Plugin augmentation.
  - **Pass criteria**: Additional options merged into context.

##### describe('defineVibeConfig - error paths')
- **`it('rejects configuration containing unknown keys when strict mode enabled')`**
  - **Validates**: Strict mode.
  - **Pass criteria**: Error lists unknown key names.

- **`it('surfaces validation errors from schema with pointer paths')`**
  - **Validates**: Error reporting.
  - **Pass criteria**: Error message includes schema path.

#### Integration Tests

##### describe('defineVibeConfig - integration')
- **`it('exposes defaults to vibeTest context after load')`**
  - **Validates**: Flow into tests.
  - **Pass criteria**: context.config equals expected values.

- **`it('passes budget and model defaults into AgentRunner runs')`**
  - **Validates**: AgentRunner integration.
  - **Pass criteria**: AgentRunner receives config-derived options.

- **`it('loads config from config file path and merges env overrides')`**
  - **Validates**: File loading pipeline.
  - **Pass criteria**: Loaded config matches expected structure.

---

#### Module: Config Validation & Defaults\n**Location**: `src/config/validation.ts`\\n**Dependencies**: zod schemas, default constant definitions.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 8
  - Focus on schema enforcement, partial merges, error messaging, default injection.
- **Integration Tests**: 1
  - Validate integration with defineVibeConfig pipeline.

### Test Scaffolds

#### Unit Tests

##### describe('configValidation - base schema')
- **`it('accepts minimal valid configuration')`**
  - **Validates**: Baseline acceptance.
  - **Pass criteria**: Validation passes; defaults inserted.

- **`it('rejects unknown keys with detailed path information')`**
  - **Validates**: Strict validation.
  - **Pass criteria**: Error path lists unknown key.

##### describe('configValidation - defaults')
- **`it('injects default model and budget when omitted')`**
  - **Validates**: Default injection.
  - **Pass criteria**: Output includes default values.

- **`it('merges partial plugin config into defaults')`**
  - **Validates**: Partial merging.
  - **Pass criteria**: Missing plugin fields filled from defaults.

##### describe('configValidation - environment overrides')
- **`it('validates environment override objects recursively')`**
  - **Validates**: Override schema.
  - **Pass criteria**: Invalid override surfaces nested error path.

- **`it('supports deprecated fields with warning metadata')`**
  - **Validates**: Deprecation warnings.
  - **Pass criteria**: Warnings array includes field name.

##### describe('configValidation - error formatting')
- **`it('aggregates multiple validation errors into single message')`**
  - **Validates**: Error formatting.
  - **Pass criteria**: Message includes bullet list of errors.

- **`it('maps zod issues to user-friendly suggestions')`**
  - **Validates**: Friendly error output.
  - **Pass criteria**: Suggestions array includes fix guidance.

#### Integration Tests

##### describe('configValidation - integration')
- **`it('pipes validation results into defineVibeConfig and surfaces errors')`**
  - **Validates**: Pipeline connection.
  - **Pass criteria**: Invalid config throws aggregated error consumed by defineVibeConfig.

---

### 4.8 File Change Tracking

#### Module: Git State Capture\n**Location**: `src/git/captureGitState.ts`\\n**Dependencies**: simple-git or native git CLI, filesystem.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 7
  - Focus on detection logic, branch info, dirty state, non-git fallback, workspace ignore.
- **Integration Tests**: 2
  - Run against temporary git repositories.

### Test Scaffolds

#### Unit Tests

##### describe('captureGitState - detection')
- **`it('returns git metadata when repository detected')`**
  - **Validates**: Happy path.
  - **Pass criteria**: Output includes branch, commit, root path.

- **`it('returns gitCaptured=false when workspace not in git repo')`**
  - **Validates**: Non-git fallback.
  - **Pass criteria**: Response indicates not captured.

##### describe('captureGitState - status parsing')
- **`it('parses staged and unstaged files from git status output')`**
  - **Validates**: Status parsing.
  - **Pass criteria**: Files arrays match mocked output.

- **`it('detects detached HEAD and sets branch=null with descriptive label')`**
  - **Validates**: Detached HEAD handling.
  - **Pass criteria**: Output branch null, message includes commit short hash.

##### describe('captureGitState - workspace ignore')
- **`it('ignores paths matching ignore patterns from config')`**
  - **Validates**: Ignore support.
  - **Pass criteria**: Ignored files excluded.

- **`it('handles git command failure by returning partial data and warning')`**
  - **Validates**: Error handling.
  - **Pass criteria**: Warning logged, partial data returned.

- **`it('supports custom git binary path from config')`**
  - **Validates**: Custom binary usage.
  - **Pass criteria**: Command executed with provided path.

#### Integration Tests

##### describe('captureGitState - temp repo integration')
- **`it('captures branch, commit, and status from temp repo with changes')`**
  - **Validates**: Real git integration.
  - **Pass criteria**: Output matches actual git status.

- **`it('respects ignore patterns when capturing state in temp repo')`**
  - **Validates**: Ignore interplay.
  - **Pass criteria**: Ignored file absent from results.

---

#### Module: File Diff Generation\n**Location**: `src/git/generateDiff.ts`\\n**Dependencies**: diff libraries, git metadata.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 6
  - Focus on diff formatting, rename detection, binary file handling, truncation thresholds.
- **Integration Tests**: 2
  - Validate diff generation using recorder scenarios.

### Test Scaffolds

#### Unit Tests

##### describe('generateDiff - formatting')
- **`it('produces unified diff with context lines per spec')`**
  - **Validates**: Diff formatting.
  - **Pass criteria**: Output matches expected unified diff string.

- **`it('truncates diff when exceeding maxLines adding summary footer')`**
  - **Validates**: Truncation policy.
  - **Pass criteria**: Diff ends with summary message.

##### describe('generateDiff - rename detection')
- **`it('labels rename when similarity above threshold')`**
  - **Validates**: Rename detection.
  - **Pass criteria**: Output includes `rename from/to`.

- **`it('treats rename as add+delete when similarity below threshold')`**
  - **Validates**: Threshold behavior.
  - **Pass criteria**: Output shows separate add/delete.

##### describe('generateDiff - binary and errors')
- **`it('marks binary files with placeholder message')`**
  - **Validates**: Binary handling.
  - **Pass criteria**: Output contains `Binary files differ`.

- **`it('throws descriptive error when git diff command fails')`**
  - **Validates**: Error handling.
  - **Pass criteria**: Error includes command and exit code.

#### Integration Tests

##### describe('generateDiff - recorder integration')
- **`it('produces diff snapshot for multi-file refactor scenario')`**
  - **Validates**: End-to-end diff generation.
  - **Pass criteria**: Snapshot matches expected output.

- **`it('handles large change set scenario with truncation summary')`**
  - **Validates**: Large diff handling.
  - **Pass criteria**: Diff truncated with summary per policy.

---

#### Module: Before/After Content Storage\n**Location**: `src/git/fileSnapshots.ts`\\n**Dependencies**: Content store, fs.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 6
  - Focus on snapshot creation, hash linking, lazy retrieval, truncation, binary detection.
- **Integration Tests**: 2
  - Ensure snapshots stored within RunBundle.

### Test Scaffolds

#### Unit Tests

##### describe('fileSnapshots - capture')
- **`it('writes before and after content to content store returning hashes')`**
  - **Validates**: Snapshot creation.
  - **Pass criteria**: Hashes returned and stored.

- **`it('marks binary files and skips inline preview generation')`**
  - **Validates**: Binary detection.
  - **Pass criteria**: Snapshot flagged `binary=true`.

##### describe('fileSnapshots - truncation and previews')
- **`it('truncates preview content to configured max length with ellipsis')`**
  - **Validates**: Truncation behavior.
  - **Pass criteria**: Preview length equals limit with ellipsis.

- **`it('provides unified preview object including before/after segments')`**
  - **Validates**: Preview structure.
  - **Pass criteria**: Preview contains before/after strings with line numbers.

##### describe('fileSnapshots - retrieval')
- **`it('lazy loads content from content store on demand')`**
  - **Validates**: Lazy retrieval.
  - **Pass criteria**: Content fetched when requested via `text()` method.

- **`it('handles missing content hash by throwing descriptive error')`**
  - **Validates**: Error handling.
  - **Pass criteria**: Error includes file path and hash.

#### Integration Tests

##### describe('fileSnapshots - RunBundle integration')
- **`it('stores snapshot references in RunBundle metadata for recorder scenario')`**
  - **Validates**: Storage integration.
  - **Pass criteria**: RunBundle entries reference hashes stored in content store.

- **`it('retrieves snapshot content for reporter rendering without duplication')`**
  - **Validates**: Reporter usage.
  - **Pass criteria**: Reporter obtains content through lazy loader; no duplicate writes.

---

### 4.9 Tool Call Processing

#### Module: PreToolUse/PostToolUse Correlation\n**Location**: `src/tools/correlation.ts`\\n**Dependencies**: Hook events, ContextManager, logging.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 8
  - Focus on correlation ID mapping, missing counterpart handling, concurrency, ordering.
- **Integration Tests**: 3
  - Replay recorder streams verifying deterministic correlation.

### Test Scaffolds

#### Unit Tests

##### describe('correlateToolHooks - matching')
- **`it('pairs PreToolUse and PostToolUse events with shared correlation ID')`**
  - **Validates**: Basic correlation.
  - **Pass criteria**: Pair stored with matching ID.

- **`it('queues multiple concurrent tools and maintains separate IDs')`**
  - **Validates**: Concurrency handling.
  - **Pass criteria**: Each tool tracked independently.

##### describe('correlateToolHooks - missing counterparts')
- **`it('marks missing PostToolUse as partial and logs warning')`**
  - **Validates**: Missing Post handling.
  - **Pass criteria**: Warning logged; status partial.

- **`it('ignores PostToolUse without matching Pre and logs anomaly')`**
  - **Validates**: Orphan Post handling.
  - **Pass criteria**: Post ignored; anomaly recorded.

##### describe('correlateToolHooks - ordering')
- **`it('orders correlated tool entries by Pre timestamp')`**
  - **Validates**: Ordering.
  - **Pass criteria**: Output sorted ascending.

- **`it('handles repeated Pre events with same ID by generating unique suffix')`**
  - **Validates**: Collision handling.
  - **Pass criteria**: IDs suffixed; warning emitted.

##### describe('correlateToolHooks - reset & cleanup')
- **`it('resets correlation map between runs')`**
  - **Validates**: Reset behavior.
  - **Pass criteria**: Map empty at new run.

- **`it('cleans up correlation entries after Post processed')`**
  - **Validates**: Cleanup.
  - **Pass criteria**: Map entry removed post processing.

#### Integration Tests

##### describe('correlateToolHooks - recorder integration')
- **`it('replays successful tool sequence and produces correlated timeline')`**
  - **Validates**: End-to-end success.
  - **Pass criteria**: Timeline matches fixture.

- **`it('captures tool failure scenario preserving error metadata in correlation')`**
  - **Validates**: Failure integration.
  - **Pass criteria**: Correlation entry includes error info.

- **`it('handles long-running tool scenario ensuring correlation persists across watchers')`**
  - **Validates**: Longevity.
  - **Pass criteria**: Correlation maintained until completion.

---

#### Module: ToolCall Record Creation\n**Location**: `src/tools/ToolCallRecord.ts`\\n**Dependencies**: Tool metadata, attachments, stdout/stderr capture.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 7
  - Focus on normalization, truncated outputs, attachment linking, error fields.
- **Integration Tests**: 2
  - Ensure records integrate into ContextManager timeline.

### Test Scaffolds

#### Unit Tests

##### describe('ToolCallRecord - normalization')
- **`it('normalizes tool arguments into JSON string preserving order')`**
  - **Validates**: Argument normalization.
  - **Pass criteria**: JSON string matches expected ordering.

- **`it('captures stdout/stderr up to max length with truncation indicator')`**
  - **Validates**: Output capture.
  - **Pass criteria**: Output truncated with ellipsis when exceeding limit.

##### describe('ToolCallRecord - attachments')
- **`it('stores attachment references with content hashes and names')`**
  - **Validates**: Attachment linking.
  - **Pass criteria**: Attachments array contains hash + name.

- **`it('omits attachments when none provided and ensures array empty')`**
  - **Validates**: Default behavior.
  - **Pass criteria**: Attachments array empty without nulls.

##### describe('ToolCallRecord - errors & metadata')
- **`it('records error stack and message when PostToolUse indicates failure')`**
  - **Validates**: Error capture.
  - **Pass criteria**: Record includes error object.

- **`it('sets duration based on Pre/Post timestamps')`**
  - **Validates**: Duration calculation.
  - **Pass criteria**: Duration equals Post-Pre.

- **`it('flags records as cached when reused from previous runs')`**
  - **Validates**: Cache metadata.
  - **Pass criteria**: `cached=true` when record reused.

#### Integration Tests

##### describe('ToolCallRecord - integration')
- **`it('inserts records into ContextManager timeline preserving order')`**
  - **Validates**: Timeline integration.
  - **Pass criteria**: Timeline contains record at expected position.

- **`it('links attachments to content store entries accessible via RunResult')`**
  - **Validates**: Attachment integration.
  - **Pass criteria**: RunResult attachments reference same hashes.

---

#### Module: Tool Timeline Construction\n**Location**: `src/tools/timeline.ts`\\n**Dependencies**: ToolCall records, hooks, formatting utilities.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 6
  - Focus on chronological ordering, grouping by agent/run, highlighting errors, deduping.
- **Integration Tests**: 2
  - Generate timeline from recorder data verifying alignment with hook order.

### Test Scaffolds

#### Unit Tests

##### describe('toolTimeline - ordering')
- **`it('sorts tool calls by start timestamp ascending')`**
  - **Validates**: Ordering logic.
  - **Pass criteria**: Output sorted ascending.

- **`it('deduplicates duplicate tool events based on correlation ID')`**
  - **Validates**: Deduping.
  - **Pass criteria**: Duplicate removed; log entry emitted.

##### describe('toolTimeline - grouping & metadata')
- **`it('groups tool calls by run and agent for display')`**
  - **Validates**: Grouping.
  - **Pass criteria**: Timeline sections labeled per run/agent.

- **`it('calculates duration for each tool call using start/end timestamps')`**
  - **Validates**: Duration computation.
  - **Pass criteria**: Duration equals difference.

##### describe('toolTimeline - error highlighting')
- **`it('marks failed tool calls with error badge and message')`**
  - **Validates**: Error highlighting.
  - **Pass criteria**: Entry includes error badge and message.

- **`it('handles missing timestamps gracefully by labeling duration as unknown')`**
  - **Validates**: Missing data handling.
  - **Pass criteria**: Entry shows `duration: unknown`.

#### Integration Tests

##### describe('toolTimeline - recorder integration')
- **`it('produces timeline matching recorder scenario order for successful run')`**
  - **Validates**: End-to-end success case.
  - **Pass criteria**: Timeline equals fixture snapshot.

- **`it('renders error annotations for failed tool scenario from recorder data')`**
  - **Validates**: Error case integration.
  - **Pass criteria**: Timeline entries show error badges matching fixture.

---

### 4.10 Workflow System

#### Module: Stage Management\n**Location**: `src/workflow/StageManager.ts`\\n**Dependencies**: WorkflowContext, logging, configuration.\\n**Complexity**: High

### Test Coverage Strategy
- **Unit Tests**: 10
  - Focus on stage lifecycle, concurrency control, metadata propagation, error propagation.
- **Integration Tests**: 3
  - Collaboration with vibeWorkflow and AgentRunner.

### Test Scaffolds

#### Unit Tests

##### describe('StageManager - registration')
- **`it('registers stage with unique ID and metadata payload')`**
  - **Validates**: Registration API.
  - **Pass criteria**: Returned ID unique; metadata stored.

- **`it('emits stageStarted and stageFinished events in order')`**
  - **Validates**: Lifecycle events.
  - **Pass criteria**: Event emitter receives start then finish.

##### describe('StageManager - concurrency control')
- **`it('queues stage executions to prevent overlap')`**
  - **Validates**: Concurrency guard.
  - **Pass criteria**: Second stage begins after first completes.

- **`it('supports cancellation of pending stages when workflow aborts')`**
  - **Validates**: Cancellation path.
  - **Pass criteria**: Pending stages not executed; cancellation events emitted.

##### describe('StageManager - metadata & timeouts')
- **`it('records start/end timestamps and duration for each stage')`**
  - **Validates**: Timing metadata.
  - **Pass criteria**: Duration equals end-start.

- **`it('enforces stage-level timeout aborting when exceeded')`**
  - **Validates**: Timeout enforcement.
  - **Pass criteria**: Timeout triggers abort error with stage name.

##### describe('StageManager - error propagation')
- **`it('wraps stage errors with stage metadata for reporting')`**
  - **Validates**: Error augmentation.
  - **Pass criteria**: Error message includes stage ID/name.

- **`it('marks stage as failed and continues cleanup when error occurs')`**
  - **Validates**: Failure handling.
  - **Pass criteria**: Cleanup invoked; stage state flagged failed.

##### describe('StageManager - nested stages')
- **`it('warns when nested stage created without allowNested flag')`**
  - **Validates**: Nesting guard.
  - **Pass criteria**: Warning logged.

- **`it('supports nested stage registration when allowNested=true keeping hierarchy')`**
  - **Validates**: Controlled nesting.
  - **Pass criteria**: Child stage recorded with parent reference.

#### Integration Tests

##### describe('StageManager - workflow integration')
- **`it('drives multi-stage workflow recording timeline events')`**
  - **Validates**: Integration with vibeWorkflow.
  - **Pass criteria**: Timeline entries match stage order.

- **`it('propagates stage failure to vibeTest while executing cleanup')`**
  - **Validates**: Error propagation.
  - **Pass criteria**: Test fails with stage metadata; cleanup executed.

- **`it('integrates with AgentRunner watchers to emit stage-scoped updates')`**
  - **Validates**: Watcher coordination.
  - **Pass criteria**: Watchers receive stage context updates.

---

#### Module: Cross-Stage Context\n**Location**: `src/workflow/WorkflowContext.ts`\\n**Dependencies**: StageManager, context storage, serialization.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 8
  - Focus on shared state management, isolation, snapshotting, rollback on failure.
- **Integration Tests**: 2
  - Ensure data accessible across stages in vibeWorkflow integration tests.

### Test Scaffolds

#### Unit Tests

##### describe('WorkflowContext - state management')
- **`it('stores and retrieves values via set/get with stage scoping')`**
  - **Validates**: Basic storage.
  - **Pass criteria**: get returns value for given key/stage.

- **`it('isolates stage-local values while allowing global reads')`**
  - **Validates**: Isolation semantics.
  - **Pass criteria**: Stage-specific values not visible to others unless global flag set.

##### describe('WorkflowContext - transactions')
- **`it('rolls back transaction when callback throws error')`**
  - **Validates**: Transaction rollback.
  - **Pass criteria**: State restored to previous snapshot.

- **`it('commits transaction when callback resolves successfully')`**
  - **Validates**: Commit path.
  - **Pass criteria**: Changes persist after callback.

##### describe('WorkflowContext - serialization')
- **`it('produces serializable snapshot for RunBundle storage')`**
  - **Validates**: Snapshot export.
  - **Pass criteria**: Snapshot matches expected structure.

- **`it('restores context from serialized snapshot without mutation')`**
  - **Validates**: Snapshot import.
  - **Pass criteria**: Restored context equals original.

##### describe('WorkflowContext - helpers')
- **`it('supports derive method to compute values lazily with caching')`**
  - **Validates**: Derived values.
  - **Pass criteria**: Derived function invoked once; cached result reused.

- **`it('tracks provenance metadata for stored values for debugging')`**
  - **Validates**: Metadata tracking.
  - **Pass criteria**: Metadata includes stage ID and setter info.

#### Integration Tests

##### describe('WorkflowContext - workflow integration')
- **`it('shares data from plan stage to execution stage via context')`**
  - **Validates**: Cross-stage sharing.
  - **Pass criteria**: Stage B reads value stored by Stage A.

- **`it('rolls back state when stage fails ensuring subsequent stages see previous snapshot')`**
  - **Validates**: Rollback integration.
  - **Pass criteria**: After failure, context matches snapshot before stage.

---

#### Module: Loop/Iteration Helpers (`until()` )\n**Location**: `src/workflow/until.ts`\\n**Dependencies**: StageManager, AgentRunner, Judge system.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 7
  - Focus on termination conditions, max iterations, jitter/delay, failure escalation.
- **Integration Tests**: 2
  - Validate interplay with AgentRunner and judge results.

### Test Scaffolds

#### Unit Tests

##### describe('until - termination')
- **`it('stops loop when predicate returns true')`**
  - **Validates**: Success termination.
  - **Pass criteria**: Loop executed expected iterations, resolves with result.

- **`it('throws UntilExceededError when maxIterations reached without success')`**
  - **Validates**: Max iteration enforcement.
  - **Pass criteria**: Error thrown with iteration count.

##### describe('until - delays & jitter')
- **`it('applies configured delay between iterations')`**
  - **Validates**: Delay handling.
  - **Pass criteria**: Delay function invoked with expected ms.

- **`it('applies jitter function to vary delay when provided')`**
  - **Validates**: Jitter usage.
  - **Pass criteria**: Delay values vary according to jitter.

##### describe('until - error handling')
- **`it('aggregates errors from failed iterations and surfaces summary')`**
  - **Validates**: Error aggregation.
  - **Pass criteria**: Error includes list of iteration failures.

- **`it('supports abort signal to cancel loop early')`**
  - **Validates**: Abort integration.
  - **Pass criteria**: Loop rejects with AbortError.

- **`it('emits telemetry metrics for iteration count and duration')`**
  - **Validates**: Telemetry instrumentation.
  - **Pass criteria**: Telemetry spy receives metrics.

#### Integration Tests

##### describe('until - workflow integration')
- **`it('repeats agent run with judge gating until rubric passes using recorder data')`**
  - **Validates**: End-to-end behavior.
  - **Pass criteria**: Loop completes when judge returns pass; recorded runs match expected count.

- **`it('stops loop early when abort signal triggered by budget enforcer')`**
  - **Validates**: Abort interplay.
  - **Pass criteria**: Loop aborts with budget error; partial results retained.

---

### 4.11 Error Handling

#### Module: Graceful Degradation\n**Location**: `src/errors/graceful.ts`\\n**Dependencies**: ContextManager, logging, RunResult builder.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 6
  - Focus on fallback paths for missing hooks, missing git, partial storage.
- **Integration Tests**: 2
  - Simulate degraded recorder scenarios.

### Test Scaffolds

#### Unit Tests

##### describe('gracefulDegradation - hooks')
- **`it('marks hookCaptureStatus partial when hook data missing')`**
  - **Validates**: Hook fallback.
  - **Pass criteria**: RunResult updated, warning logged once.

- **`it('retains captured hooks while omitting missing ones without crashing')`**
  - **Validates**: Partial data retention.
  - **Pass criteria**: Existing hooks remain accessible.

##### describe('gracefulDegradation - git and storage')
- **`it('sets gitCaptured=false when git detection fails and logs warning')`**
  - **Validates**: Git fallback.
  - **Pass criteria**: RunResult.git undefined, warning emitted.

- **`it('uses minimal RunResult payload when storage persistence fails')`**
  - **Validates**: Storage fallback.
  - **Pass criteria**: Minimal result returned; error captured.

##### describe('gracefulDegradation - messaging')
- **`it('aggregates degradation warnings into RunResult warnings array')`**
  - **Validates**: Warning aggregation.
  - **Pass criteria**: Warnings array contains entries with remediation hints.

- **`it('ensures fallback does not throw even when multiple systems degrade simultaneously')`**
  - **Validates**: Multi-failure resilience.
  - **Pass criteria**: Combined fallback returns partial result.

#### Integration Tests

##### describe('gracefulDegradation - recorder scenarios')
- **`it('handles missing hook fixture by returning partial RunResult with warning')`**
  - **Validates**: End-to-end fallback.
  - **Pass criteria**: RunResult partial, warning logged once.

- **`it('continues workflow when storage write fails using minimal result')`**
  - **Validates**: Storage fallback integration.
  - **Pass criteria**: Workflow continues, minimal result recorded.

---

#### Module: Hook Failure Scenarios\n**Location**: `src/errors/hookFailure.ts`\\n**Dependencies**: Hook capture system, logging.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 5
  - Focus on error classification, retry decision, structured logging, telemetry emission.
- **Integration Tests**: 1
  - Ensure classification consumed by ContextManager.

### Test Scaffolds

#### Unit Tests

##### describe('hookFailure - classification')
- **`it('classifies missing PostToolUse as recoverable hook error')`**
  - **Validates**: Classification mapping.
  - **Pass criteria**: Category `recoverable` returned.

- **`it('classifies duplicate hook IDs as fatal')`**
  - **Validates**: Duplicate detection.
  - **Pass criteria**: Category `fatal` with message referencing duplicate ID.

##### describe('hookFailure - retry policy')
- **`it('recommends retry when error classified as transient')`**
  - **Validates**: Retry guidance.
  - **Pass criteria**: Recommendation includes `retry: true`.

- **`it('emits telemetry event with hook type and classification')`**
  - **Validates**: Telemetry emission.
  - **Pass criteria**: Telemetry spy receives payload.

##### describe('hookFailure - logging')
- **`it('logs structured message with remediation hint')`**
  - **Validates**: Logging contract.
  - **Pass criteria**: Log entry includes `remediation` field.

#### Integration Tests

##### describe('hookFailure - context integration')
- **`it('applies classification to RunResult and watcher notifications')`**
  - **Validates**: Integration with ContextManager.
  - **Pass criteria**: RunResult warnings include classification summary; watcher receives event.

---

#### Module: Storage Failure Scenarios\n**Location**: `src/errors/storageFailure.ts`\\n**Dependencies**: RunBundleStore, cleanup policy, logging.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 5
  - Focus on retry policy, exponential backoff, fallback to temp storage, user guidance.
- **Integration Tests**: 1
  - Simulate disk full scenario.

### Test Scaffolds

#### Unit Tests

##### describe('storageFailure - retry logic')
- **`it('retries recoverable errors up to configured maxRetries with exponential backoff')`**
  - **Validates**: Retry/backoff policy.
  - **Pass criteria**: Retry invoked expected times; delay increases exponentially.

- **`it('stops retrying when error classified as fatal')`**
  - **Validates**: Fatal handling.
  - **Pass criteria**: No retries executed; error thrown immediately.

##### describe('storageFailure - fallback storage')
- **`it('writes minimal run summary to temp directory when primary store unavailable')`**
  - **Validates**: Fallback path.
  - **Pass criteria**: Temp file created with summary data.

- **`it('logs user guidance with path to temp storage for manual recovery')`**
  - **Validates**: Guidance messaging.
  - **Pass criteria**: Log includes instructions to move files.

##### describe('storageFailure - aggregation')
- **`it('aggregates multiple errors into StorageFailureAggregateError with context')`**
  - **Validates**: Error aggregation.
  - **Pass criteria**: Aggregate error contains list of underlying errors.

#### Integration Tests

##### describe('storageFailure - disk full scenario')
- **`it('falls back to temp storage when disk quota exceeded and reports partial status')`**
  - **Validates**: End-to-end fallback.
  - **Pass criteria**: RunResult flagged partial; temp file created.

---

#### Module: SDK Timeout Handling\n**Location**: `src/errors/sdkTimeout.ts`\\n**Dependencies**: AgentRunner, Claude SDK bridge, abort controllers.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 6
  - Focus on timeout detection, abort integration, fallback plan invocation, logging.
- **Integration Tests**: 2
  - Replay recorder scenario with simulated timeout.

### Test Scaffolds

#### Unit Tests

##### describe('sdkTimeout - detection')
- **`it('starts timer using configured timeout duration at run start')`**
  - **Validates**: Timer initialization.
  - **Pass criteria**: Timer scheduled with correct duration.

- **`it('cancels timer when run completes before timeout')`**
  - **Validates**: Cleanup behavior.
  - **Pass criteria**: Timer cleared; no timeout triggered.

##### describe('sdkTimeout - handling')
- **`it('aborts AgentRunner execution via AbortController when timeout fires')`**
  - **Validates**: Abort integration.
  - **Pass criteria**: Abort signal triggered; SDK receives abort.

- **`it('invokes fallback strategy callback after abort')`**
  - **Validates**: Fallback invocation.
  - **Pass criteria**: Fallback called with context data.

##### describe('sdkTimeout - logging & escalation')
- **`it('logs timeout warning including elapsed duration and model info')`**
  - **Validates**: Logging detail.
  - **Pass criteria**: Log contains duration, model.

- **`it('escalates to fatal error after consecutive timeouts exceed limit')`**
  - **Validates**: Escalation policy.
  - **Pass criteria**: Throws `SdkTimeoutExceededError`.

#### Integration Tests

##### describe('sdkTimeout - recorder playback')
- **`it('simulates timeout scenario and verifies fallback run executed')`**
  - **Validates**: End-to-end fallback.
  - **Pass criteria**: First run aborted; fallback run completes.

- **`it('records timeout event in RunResult timeline with warning entry')`**
  - **Validates**: Reporting integration.
  - **Pass criteria**: Timeline includes timeout entry, RunResult warnings updated.

---

### 4.12 Performance & Cost Tracking

#### Module: Token Counting\n**Location**: `src/cost/tokenCounter.ts`\\n**Dependencies**: Model metadata, hook events.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 8
  - Focus on accumulation per agent run, multi-model support, streaming messages, zero-token cases.
- **Integration Tests**: 1
  - Validate totals align with recorder scenario usage.

### Test Scaffolds

#### Unit Tests

##### describe('tokenCounter - accumulation')
- **`it('counts prompt and completion tokens per run using model metadata')`**
  - **Validates**: Basic accumulation.
  - **Pass criteria**: Totals equal sum of events.

- **`it('resets counts between separate agent runs')`**
  - **Validates**: Reset behavior.
  - **Pass criteria**: Second run starts at zero.

##### describe('tokenCounter - multi-model support')
- **`it('tracks usage per model when runs use different models')`**
  - **Validates**: Model grouping.
  - **Pass criteria**: Usage map contains entries per model.

- **`it('estimates tokens when usage data missing using fallback estimator')`**
  - **Validates**: Estimation logic.
  - **Pass criteria**: Estimate matches fallback algorithm.

##### describe('tokenCounter - streaming messages')
- **`it('aggregates streaming partial tokens emitted via delta events')`**
  - **Validates**: Streaming support.
  - **Pass criteria**: Final count equals sum of partials.

- **`it('handles zero-token tool runs without affecting totals')`**
  - **Validates**: Zero case.
  - **Pass criteria**: Totals unchanged.

##### describe('tokenCounter - reporting')
- **`it('exposes snapshot of usage suitable for RunResult serialization')`**
  - **Validates**: Snapshot formatting.
  - **Pass criteria**: Snapshot matches schema.

- **`it('emits telemetry event when usage exceeds configured threshold')`**
  - **Validates**: Telemetry integration.
  - **Pass criteria**: Event emitted when threshold crossed.

#### Integration Tests

##### describe('tokenCounter - recorder alignment')
- **`it('matches recorded token usage from simple-file-edit scenario')`**
  - **Validates**: End-to-end accuracy.
  - **Pass criteria**: Count equals fixture usage numbers.

---

#### Module: Cost Calculation\n**Location**: `src/cost/costCalculator.ts`\\n**Dependencies**: Pricing table, currency formatter, token counter.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 7
  - Focus on pricing lookups, rounding, currency conversion, multi-run aggregation.
- **Integration Tests**: 2
  - Validate cost totals propagate to reporters and RunResult.

### Test Scaffolds

#### Unit Tests

##### describe('costCalculator - base pricing')
- **`it('calculates cost from token usage using pricing table per model')`**
  - **Validates**: Pricing lookup.
  - **Pass criteria**: Cost equals usage * price.

- **`it('throws error when model pricing missing with helpful message')`**
  - **Validates**: Missing pricing handling.
  - **Pass criteria**: Error lists missing model.

##### describe('costCalculator - rounding & currencies')
- **`it('rounds totals to two decimal places in USD')`**
  - **Validates**: Rounding.
  - **Pass criteria**: Value equals expected rounding.

- **`it('supports alternative currency conversion using provided rates')`**
  - **Validates**: Currency conversion.
  - **Pass criteria**: Converted total matches rate.

##### describe('costCalculator - aggregation')
- **`it('aggregates costs across multiple runs maintaining per-run breakdown')`**
  - **Validates**: Aggregation.
  - **Pass criteria**: Summary totals match sum; breakdown preserved.

- **`it('caches pricing data for repeated lookups to avoid recomputation')`**
  - **Validates**: Caching.
  - **Pass criteria**: Subsequent calls reuse cached pricing.

- **`it('includes zero-cost runs without affecting totals')`**
  - **Validates**: Zero case.
  - **Pass criteria**: Totals unchanged.

#### Integration Tests

##### describe('costCalculator - integration')
- **`it('produces RunResult cost summary consumed by TerminalCostReporter')`**
  - **Validates**: Reporter integration.
  - **Pass criteria**: Reporter output matches calculator totals.

- **`it('updates budget enforcer with cumulative cost across workflow stages')`**
  - **Validates**: Budget interplay.
  - **Pass criteria**: Budget enforcer receives updated totals.

---

#### Module: Budget Enforcement\n**Location**: `src/cost/budgetEnforcer.ts`\\n**Dependencies**: Cost calculator, AgentRunner, configuration.\\n**Complexity**: Medium

### Test Coverage Strategy
- **Unit Tests**: 6
  - Focus on threshold detection, warning emission, hard-stop enforcement, budget inheritance.
- **Integration Tests**: 2
  - Validate AgentRunner abort and reporter output.

### Test Scaffolds

#### Unit Tests

##### describe('budgetEnforcer - thresholds')
- **`it('emits warning when cost exceeds warningThreshold percent of budget')`**
  - **Validates**: Warning logic.
  - **Pass criteria**: Warning event emitted once at threshold.

- **`it('aborts run when cost exceeds hard limit')`**
  - **Validates**: Hard stop enforcement.
  - **Pass criteria**: Throws `BudgetExceededError` and signals abort.

##### describe('budgetEnforcer - inheritance')
- **`it('inherits budget from parent workflow stage when child not configured')`**
  - **Validates**: Inheritance logic.
  - **Pass criteria**: Child budget equals parent value.

- **`it('allows child stage to override budget with smaller limit')`**
  - **Validates**: Override behavior.
  - **Pass criteria**: Child limit applied; parent unaffected.

##### describe('budgetEnforcer - resets & disable')
- **`it('resets spent amount between tests while preserving global totals')`**
  - **Validates**: Reset semantics.
  - **Pass criteria**: New test starts at zero.

- **`it('respects disable flag allowing runs to bypass enforcement')`**
  - **Validates**: Disable option.
  - **Pass criteria**: No warnings or aborts triggered.

#### Integration Tests

##### describe('budgetEnforcer - agent integration')
- **`it('aborts AgentRunner when budget exceeded and records warning in RunResult')`**
  - **Validates**: End-to-end enforcement.
  - **Pass criteria**: RunResult status aborted; warning present.

- **`it('emits reporter banner highlighting budget breach')`**
  - **Validates**: Reporter interplay.
  - **Pass criteria**: Terminal reporter output includes budget banner.

---

## 5. Architecture Decisions

### Decision 1: Claude Code SDK Mocking Strategy
- **Decision**: Hybrid recorder + deterministic mocks
- **Date**: 2025-10-07
- **Rationale**: Balances fidelity for complex flows with speed for simple unit tests. Recorder ensures real-world behavior captured; mocks keep simple tests lightweight.
- **Trade-offs**: Dual maintenance burden; mitigated by documentation and lint rules.
- **Alternatives considered**: Pure recorder (higher maintenance for simple cases), pure mocks (insufficient realism).

### Decision 2: Fixture Architecture Pattern
- **Decision**: Constructor-based fixture factories with explicit dependency injection.
- **Rationale**: Enables isolation, reusability, and clarity for LLM-generated code.
- **Examples**: `createAgentRunnerFixture({ sdkClient, storage })`, `createRunBundleStoreFixture({ fs, clock })`.
- **Guidelines**: Fixtures return tuple `{ instance, dependencies }`; tests customize via options object.

### Decision 3: Test Organization Structure
- **Decision**: Mirror source structure under `tests/` with unit/integration/e2e directories.
- **Rationale**: Improves discoverability and alignment with spec sections.
- **Structure**:
```
tests/
  unit/
    agent/
    storage/
    workflow/
  integration/
    agent-runner/
    reporters/
  e2e/
    workflows/
  __fixtures__/
  __snapshots__/
  utils/
```

### Decision 4: Snapshot Usage Policy
- **Decision**: Snapshots permitted only for reporter outputs and serialized bundles.
- **Rationale**: Avoid brittle snapshots for dynamic data; focus on human-reviewable artifacts.

### Decision 5: Coverage Enforcement
- **Decision**: Module-specific coverage thresholds enforced via configuration in `vitest.config.ts`.
- **Rationale**: Prioritize critical modules with higher thresholds; ensures sustained quality.

---

## 6. Implementation Roadmap

### 6.1 Implementation Order
1. **Fixture infrastructure**: Build fixture factories and SDK replay harness. Required before writing tests.
2. **Core test infrastructure tests** (`vibeTest`, `vibeWorkflow`, context): foundational for other suites.
3. **Agent Runner & Context Manager**: Critical path; unlocks most integration scenarios.
4. **Storage system**: Needed before reporters and workflow E2E.
5. **Judge system and matchers**: Enables validation loops.
6. **Reporters and configuration**.
7. **Remaining subsystems** (matrix testing, cost tracking, error handling).
8. **E2E workflows** once unit/integration scaffolds stable.

### 6.2 Fixture Construction Guide
- Create base fixtures in `tests/fixtures/core/`. Each exposes builder functions with override parameters and default dependencies.
- Provide composition helpers, e.g., `composeAgentRunnerFixture({ sdkScenario: 'simple-file-edit' })` returning agent runner + context + storage.
- Maintain README documenting fixture responsibilities and usage patterns.

### 6.3 Assertion Patterns
- Prefer custom matchers for complex assertions (cost, hooks, git). Document usage in `tests/utils/matchers.ts`.
- Error assertions use `await expect(promise).rejects.toThrowErrorMatchingInlineSnapshot()` only when message short; otherwise string includes verifying key phrases.
- For timeline comparisons, use structured deep equality against normalized arrays to avoid ordering flakiness.

### 6.4 Test Data Management
- Recorder scenarios stored with metadata; add new ones via `pnpm test:record-sdk` script and update Appendix A table.
- Synthetic fixtures documented in `tests/__fixtures__/README.md` with maintenance notes.
- When updating fixtures, run `pnpm test:update-snapshots` to refresh reporter snapshots.

---

## 7. Maintenance & Evolution
- Review this specification quarterly or when technical spec changes. Update version header and changelog.
- Add new modules to coverage matrix and append new scenarios to recorder library.
- Keep fixtures deterministic; any non-determinism requires explicit seeding or failure.
- Document deviations from this spec in Appendix C with rationale and remediation timeline.

---

## Appendix A: Fixture Reference
- **ClaudeSdkReplayFixture**: Provides replay client for specified scenario.
- **AgentRunnerFixture**: Creates AgentRunner with injected replay client and storage mocks.
- **RunBundleStoreFixture**: Initializes temporary storage directory with cleanup helpers.
- **WorkflowStageFixture**: Provides stage context for testing workflow transitions.
- **JudgeFixture**: Supplies rubric schemas and stubbed LLM responses.

Each fixture includes README documenting parameters, default dependencies, and teardown steps.

## Appendix B: Test Naming Conventions
- File names: `<module>.<scope>.<type>.test.ts` (scope = feature, type = unit|integration|e2e).
- Describe blocks: `'[Module] - [Aspect]'` to align with this document.
- Test names: start with verb describing behavior, include condition (`returns default config when none provided`).

## Appendix C: Coverage Requirements Matrix
| Module | Coverage Target | Rationale |
| --- | --- | --- |
| Core Test Infrastructure | ≥95% | Foundation for all tests |
| Agent Runner & Context Manager | ≥95% | Critical execution path |
| Storage System | ≥92% | Persistence correctness |
| Judge System | ≥92% | LLM evaluation integrity |
| Reporters | ≥90% | Developer insights |
| Matrix Testing | ≥88% | Utility layer |
| Configuration | ≥90% | Prevent misconfiguration |
| File Change Tracking | ≥90% | Auditing accuracy |
| Tool Call Processing | ≥90% | Timeline integrity |
| Workflow System | ≥93% | High complexity orchestration |
| Error Handling | ≥90% | Resilience |
| Performance & Cost Tracking | ≥88% | Monitoring |

